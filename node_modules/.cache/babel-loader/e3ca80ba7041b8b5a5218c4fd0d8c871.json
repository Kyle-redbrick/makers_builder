{"ast":null,"code":"import _regeneratorRuntime from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/react-scripts/node_modules/@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/react-scripts/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\nimport _classCallCheck from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/react-scripts/node_modules/@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/react-scripts/node_modules/@babel/runtime/helpers/esm/createClass\";\nimport _possibleConstructorReturn from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/react-scripts/node_modules/@babel/runtime/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/react-scripts/node_modules/@babel/runtime/helpers/esm/getPrototypeOf\";\nimport _inherits from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/react-scripts/node_modules/@babel/runtime/helpers/esm/inherits\";\nvar _jsxFileName = \"/Users/jimmy/Documents/Wizschool/wizlab_web2/src/Page/Builder/Component/SoundBox/Component/CustomSound/index.js\";\nimport React from \"react\";\nimport { connect } from \"react-redux\";\nimport WaveSurfer from \"wavesurfer.js\";\nimport WaveSurferRegion from \"wavesurfer.js/dist/plugin/wavesurfer.regions\";\nimport * as sceneActions from \"../../../../Store/Reducer/scene\";\nimport AssetLibrary from \"../../../../utils/assetLibrary\";\nimport { SpriteType, URL } from \"../../../../../../Common/Util/Constant\";\nimport { encode } from \"../../../../utils/audioUtil\";\nimport * as request from \"../../../../../../Common/Util/HTTPRequest\";\nimport View from \"./View\";\n\nvar CustomSound =\n/*#__PURE__*/\nfunction (_React$Component) {\n  _inherits(CustomSound, _React$Component);\n\n  function CustomSound(props) {\n    var _this;\n\n    _classCallCheck(this, CustomSound);\n\n    _this = _possibleConstructorReturn(this, _getPrototypeOf(CustomSound).call(this, props));\n\n    _this.initWaveSurfer = function () {\n      _this.wavesurfer = WaveSurfer.create({\n        container: \".custom__sound__waveform\",\n        waveColor: \"#4287f5\",\n        progressColor: \"#05214d\",\n        plugins: [WaveSurferRegion.create({\n          regions: []\n        })]\n      });\n\n      _this.wavesurfer.on(\"ready\", function () {\n        _this.setState({\n          status: \"ready\"\n        });\n\n        _this.initRegion();\n      });\n\n      _this.wavesurfer.on(\"pause\", function () {\n        _this.setState({\n          isPlaying: false\n        });\n      });\n\n      _this.wavesurfer.on(\"play\", function () {\n        _this.setState({\n          isPlaying: true\n        });\n      });\n    };\n\n    _this.initRegion = function () {\n      var start = 0;\n\n      var end = _this.wavesurfer.getDuration();\n\n      _this.wavesurfer.clearRegions();\n\n      _this.wavesurfer.addRegion({\n        start: start,\n        end: end,\n        color: \"rgba(0, 0, 0, 0.2)\"\n      });\n    };\n\n    _this.play = function () {\n      var region = Object.values(_this.wavesurfer.regions.list)[0];\n      region.play();\n    };\n\n    _this.pause = function () {\n      _this.wavesurfer.pause();\n    };\n\n    _this.onClickTogglePlay = function () {\n      var isPlaying = _this.state.isPlaying;\n\n      if (isPlaying) {\n        _this.pause();\n      } else {\n        _this.play();\n      }\n    };\n\n    _this.onClickExport =\n    /*#__PURE__*/\n    _asyncToGenerator(\n    /*#__PURE__*/\n    _regeneratorRuntime.mark(function _callee2() {\n      return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n        while (1) {\n          switch (_context2.prev = _context2.next) {\n            case 0:\n              _this.pause();\n\n              _this.setState({\n                status: \"encoding\"\n              });\n\n              setTimeout(\n              /*#__PURE__*/\n              _asyncToGenerator(\n              /*#__PURE__*/\n              _regeneratorRuntime.mark(function _callee() {\n                var defaultName, blob, url, asset, soundNames, sound;\n                return _regeneratorRuntime.wrap(function _callee$(_context) {\n                  while (1) {\n                    switch (_context.prev = _context.next) {\n                      case 0:\n                        defaultName = _this.state.defaultName;\n                        blob = _this.encodeSound();\n                        _context.next = 4;\n                        return _this.uploadSound(blob);\n\n                      case 4:\n                        url = _context.sent;\n                        asset = _this.createAsset(url, defaultName);\n                        _context.next = 8;\n                        return request.addAsset(asset);\n\n                      case 8:\n                        //add asset to assetLibrary\n                        AssetLibrary.addSoundAsset(asset); //add sound to project\n\n                        soundNames = _this.props.soundNames ? _this.props.soundNames : {};\n                        sound = {\n                          assetId: asset.assetId,\n                          type: asset.type,\n                          name: _this.props.countUpSameName(defaultName, Object.values(soundNames))\n                        };\n\n                        _this.props.addSounds([sound]);\n\n                        _this.props.dismiss();\n\n                      case 13:\n                      case \"end\":\n                        return _context.stop();\n                    }\n                  }\n                }, _callee, this);\n              })), 100);\n\n            case 3:\n            case \"end\":\n              return _context2.stop();\n          }\n        }\n      }, _callee2, this);\n    }));\n\n    _this.onChangeFile = function (e) {\n      var file = e.target.files[0];\n      var fr = new FileReader();\n\n      fr.onload = function () {\n        _this.wavesurfer.load(fr.result);\n      };\n\n      file && fr.readAsDataURL(file);\n\n      _this.setState({\n        status: \"loading\"\n      });\n    };\n\n    _this.onChangeDefaultName = function (e) {\n      var defaultName = e.target.value;\n      if (defaultName.length > 12) defaultName = defaultName.substr(0, 12);\n      var regex = /^[a-z](?:_?[a-z0-9]+)*$/;\n      var isDefaultNameValid = regex.test(defaultName);\n\n      _this.setState({\n        defaultName: defaultName,\n        isDefaultNameValid: isDefaultNameValid\n      });\n    };\n\n    _this.createAsset = function (url, defaultName) {\n      var assetId = url.replace(\"/custom/\", \"\").replace(\".mp3\", \"\");\n      return {\n        assetId: assetId,\n        type: SpriteType.SOUND,\n        defaultName: defaultName,\n        path: url\n      };\n    };\n\n    _this.encodeSound = function () {\n      var audioBuffer = _this.wavesurfer.backend.buffer;\n      var region = Object.values(_this.wavesurfer.regions.list)[0];\n      var start = region.start,\n          end = region.end;\n      var blob = encode(audioBuffer, start, end);\n      return blob;\n    };\n\n    _this.uploadSound =\n    /*#__PURE__*/\n    function () {\n      var _ref3 = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee3(blob) {\n        var data, res, json, url;\n        return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                _context3.prev = 0;\n                data = new FormData();\n                data.append(\"file\", blob);\n                _context3.next = 5;\n                return request.uploadAsset(data, \"mp3\");\n\n              case 5:\n                res = _context3.sent;\n                _context3.next = 8;\n                return res.json();\n\n              case 8:\n                json = _context3.sent;\n                url = json.url.replace(URL.ASSET_BASE_URL, \"\");\n                return _context3.abrupt(\"return\", url);\n\n              case 13:\n                _context3.prev = 13;\n                _context3.t0 = _context3[\"catch\"](0);\n                console.error(_context3.t0);\n\n              case 16:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3, this, [[0, 13]]);\n      }));\n\n      return function (_x) {\n        return _ref3.apply(this, arguments);\n      };\n    }();\n\n    _this.state = {\n      status: \"empty\",\n      defaultName: \"custom\",\n      isPlaying: false,\n      isDefaultNameValid: true\n    };\n    return _this;\n  }\n\n  _createClass(CustomSound, [{\n    key: \"componentDidMount\",\n    value: function componentDidMount() {\n      this.initWaveSurfer();\n    }\n  }, {\n    key: \"componentWillUnmount\",\n    value: function componentWillUnmount() {\n      this.pause();\n    }\n  }, {\n    key: \"render\",\n    value: function render() {\n      var _this$state = this.state,\n          status = _this$state.status,\n          isPlaying = _this$state.isPlaying,\n          defaultName = _this$state.defaultName,\n          isDefaultNameValid = _this$state.isDefaultNameValid;\n      var onChangeFile = this.onChangeFile,\n          onClickTogglePlay = this.onClickTogglePlay,\n          onClickExport = this.onClickExport,\n          onChangeDefaultName = this.onChangeDefaultName;\n      return React.createElement(View, {\n        status: status,\n        onChangeFile: onChangeFile,\n        isPlaying: isPlaying,\n        defaultName: defaultName,\n        isDefaultNameValid: isDefaultNameValid,\n        onClickTogglePlay: onClickTogglePlay,\n        onClickExport: onClickExport,\n        onChangeDefaultName: onChangeDefaultName,\n        dismiss: this.props.dismiss,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 169\n        },\n        __self: this\n      });\n    }\n  }]);\n\n  return CustomSound;\n}(React.Component);\n\nexport default connect(function (state) {\n  return {\n    soundNames: state.scene.soundNames\n  };\n}, {\n  addSounds: sceneActions.addSounds\n})(CustomSound);","map":{"version":3,"sources":["/Users/jimmy/Documents/Wizschool/wizlab_web2/src/Page/Builder/Component/SoundBox/Component/CustomSound/index.js"],"names":["React","connect","WaveSurfer","WaveSurferRegion","sceneActions","AssetLibrary","SpriteType","URL","encode","request","View","CustomSound","props","initWaveSurfer","wavesurfer","create","container","waveColor","progressColor","plugins","regions","on","setState","status","initRegion","isPlaying","start","end","getDuration","clearRegions","addRegion","color","play","region","Object","values","list","pause","onClickTogglePlay","state","onClickExport","setTimeout","defaultName","blob","encodeSound","uploadSound","url","asset","createAsset","addAsset","addSoundAsset","soundNames","sound","assetId","type","name","countUpSameName","addSounds","dismiss","onChangeFile","e","file","target","files","fr","FileReader","onload","load","result","readAsDataURL","onChangeDefaultName","value","length","substr","regex","isDefaultNameValid","test","replace","SOUND","path","audioBuffer","backend","buffer","data","FormData","append","uploadAsset","res","json","ASSET_BASE_URL","console","error","Component","scene"],"mappings":"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","sourcesContent":["import React from \"react\";\nimport { connect } from \"react-redux\";\nimport WaveSurfer from \"wavesurfer.js\";\nimport WaveSurferRegion from \"wavesurfer.js/dist/plugin/wavesurfer.regions\";\nimport * as sceneActions from \"../../../../Store/Reducer/scene\";\nimport AssetLibrary from \"../../../../utils/assetLibrary\";\nimport { SpriteType, URL } from \"../../../../../../Common/Util/Constant\";\nimport { encode } from \"../../../../utils/audioUtil\";\nimport * as request from \"../../../../../../Common/Util/HTTPRequest\";\nimport View from \"./View\";\n\nclass CustomSound extends React.Component {\n  constructor(props) {\n    super(props);\n    this.state = {\n      status: \"empty\",\n      defaultName: \"custom\",\n      isPlaying: false,\n      isDefaultNameValid: true\n    };\n  }\n\n  componentDidMount() {\n    this.initWaveSurfer();\n  }\n\n  componentWillUnmount() {\n    this.pause();\n  }\n\n  initWaveSurfer = () => {\n    this.wavesurfer = WaveSurfer.create({\n      container: \".custom__sound__waveform\",\n      waveColor: \"#4287f5\",\n      progressColor: \"#05214d\",\n      plugins: [\n        WaveSurferRegion.create({ regions: [] })\n      ]\n    });\n\n    this.wavesurfer.on(\"ready\", () => {\n      this.setState({ status: \"ready\" });\n      this.initRegion();\n    });\n\n    this.wavesurfer.on(\"pause\", () => {\n      this.setState({ isPlaying: false });\n    })\n\n    this.wavesurfer.on(\"play\", () => {\n      this.setState({ isPlaying: true });\n    })\n  }\n\n  initRegion = () => {\n    const start = 0;\n    const end = this.wavesurfer.getDuration();\n    this.wavesurfer.clearRegions();\n    this.wavesurfer.addRegion({\n      start: start,\n      end: end,\n      color: \"rgba(0, 0, 0, 0.2)\"\n    });\n  }\n\n  play = () => {\n    const region = Object.values(this.wavesurfer.regions.list)[0];\n    region.play();\n  };\n\n  pause = () => {\n    this.wavesurfer.pause();\n  };\n\n  onClickTogglePlay = () => {\n    const { isPlaying } = this.state;\n    if(isPlaying) {\n      this.pause();\n    }else {\n      this.play();\n    }\n  }\n\n  onClickExport = async () => {\n    this.pause();\n    this.setState({ status: \"encoding\" });\n    setTimeout(async ()=>{\n      const { defaultName } = this.state;\n      const blob = this.encodeSound();\n      const url = await this.uploadSound(blob);\n      const asset = this.createAsset(url, defaultName);\n      await request.addAsset(asset);\n  \n      //add asset to assetLibrary\n      AssetLibrary.addSoundAsset(asset);\n  \n      //add sound to project\n      const soundNames = this.props.soundNames ? this.props.soundNames : {};\n      const sound = {\n        assetId: asset.assetId,\n        type: asset.type,\n        name: this.props.countUpSameName(defaultName, Object.values(soundNames))\n      };\n      this.props.addSounds([sound]);\n      this.props.dismiss();\n    }, 100);\n    \n  }\n\n  onChangeFile = e => {\n    const file = e.target.files[0];\n    const fr = new FileReader();\n    fr.onload = () => {\n      this.wavesurfer.load(fr.result);\n    };\n    file && fr.readAsDataURL(file);\n    this.setState({ status: \"loading\" })\n  }\n\n  onChangeDefaultName = e => {\n    let defaultName = e.target.value;\n    if(defaultName.length > 12) defaultName = defaultName.substr(0, 12);\n    const regex = /^[a-z](?:_?[a-z0-9]+)*$/;\n    const isDefaultNameValid = regex.test(defaultName);\n    this.setState({ defaultName, isDefaultNameValid });\n  }\n\n  createAsset = (url, defaultName) => {\n    const assetId = url.replace(\"/custom/\",\"\").replace(\".mp3\",\"\");\n    return {\n      assetId: assetId,\n      type: SpriteType.SOUND,\n      defaultName: defaultName,\n      path: url\n    };\n  }\n\n  encodeSound = () => {\n    const audioBuffer = this.wavesurfer.backend.buffer;\n    const region = Object.values(this.wavesurfer.regions.list)[0];\n    const { start, end } = region;\n    const blob = encode(audioBuffer, start, end);\n    return blob;\n  }\n\n  uploadSound = async blob => {\n    try{\n      const data = new FormData();\n      data.append(\"file\", blob);\n      \n      const res = await request.uploadAsset(data, \"mp3\");\n      const json = await res.json();\n      const url = json.url.replace(URL.ASSET_BASE_URL, \"\");\n      return url;\n    } catch(e) {\n      console.error(e);\n    }\n  }\n\n  render() {\n    const { status, isPlaying, defaultName, isDefaultNameValid } = this.state;\n    const { \n      onChangeFile,\n      onClickTogglePlay,\n      onClickExport,\n      onChangeDefaultName\n    } = this;\n    return (\n      <View\n        status={status}\n        onChangeFile={onChangeFile}\n        isPlaying={isPlaying}\n        defaultName={defaultName}\n        isDefaultNameValid={isDefaultNameValid}\n        onClickTogglePlay={onClickTogglePlay}\n        onClickExport={onClickExport}\n        onChangeDefaultName={onChangeDefaultName}\n        dismiss={this.props.dismiss}\n      />\n    );\n  }\n}\n\nexport default connect(\n  state => ({\n    soundNames: state.scene.soundNames\n  }),\n  {\n    addSounds: sceneActions.addSounds\n  }\n)(CustomSound);"]},"metadata":{},"sourceType":"module"}