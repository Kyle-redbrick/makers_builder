{"ast":null,"code":"import _toConsumableArray from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";\nimport _regeneratorRuntime from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\nimport _classCallCheck from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";\nimport _possibleConstructorReturn from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/getPrototypeOf\";\nimport _inherits from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/inherits\";\nvar _jsxFileName = \"/Users/jimmy/Documents/Wizschool/wizlab_web2/src/Page/Builder3D/Component/Publish/Container.js\";\nimport React, { Component } from \"react\";\nimport { connect } from \"react-redux\";\nimport { injectIntl } from \"react-intl\";\nimport * as request from \"../../../../Common/Util/HTTPRequest\";\nimport { ImageCompressor } from \"../../../../Common/Util/FileCompressor\";\nimport { generateBabylonPage } from \"../../../Builder/utils/gamePageGenerator\";\nimport * as builderAction from \"../../Store/Reducer/builder\";\nimport View from \"./View\";\n\nvar Container =\n/*#__PURE__*/\nfunction (_Component) {\n  _inherits(Container, _Component);\n\n  function Container(props) {\n    var _this;\n\n    _classCallCheck(this, Container);\n\n    _this = _possibleConstructorReturn(this, _getPrototypeOf(Container).call(this, props));\n\n    _this.onClickPublish = function () {\n      if (_this.checkAllFieldValid()) {\n        _this.publish(function () {\n          _this.updateDevelopingProjectIcon();\n\n          alert(\"퍼블리싱되었습니다 :)\");\n\n          _this.props.setIsPublishOn(false);\n        });\n      }\n    };\n\n    _this.handleIconChange =\n    /*#__PURE__*/\n    function () {\n      var _ref = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee(e) {\n        var selectedFile, data, compressed, icon;\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                selectedFile = e.target.files[0];\n\n                if (selectedFile) {\n                  _context.next = 3;\n                  break;\n                }\n\n                return _context.abrupt(\"return\");\n\n              case 3:\n                data = new FormData();\n                _context.next = 6;\n                return ImageCompressor(selectedFile);\n\n              case 6:\n                compressed = _context.sent;\n                data.append(\"file\", compressed);\n                _context.next = 10;\n                return request.upload(data).then(function (res) {\n                  return res.json();\n                }).then(function (json) {\n                  return json.url;\n                }).catch(function (err) {\n                  console.error(err);\n                });\n\n              case 10:\n                icon = _context.sent;\n\n                if (icon) {\n                  _this.setState({\n                    icon: icon\n                  });\n                } else {\n                  _this.setState({\n                    icon: _this.props.gameThumbnail\n                  });\n                }\n\n              case 12:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this);\n      }));\n\n      return function (_x) {\n        return _ref.apply(this, arguments);\n      };\n    }();\n\n    _this.onClickIconChange = function () {\n      var fileInput = document.getElementById(\"iconFileInput\");\n\n      if (fileInput) {\n        fileInput.click();\n      }\n    };\n\n    _this.onClickIconDelete = function () {\n      _this.setState({\n        icon: _this.props.gameThumbnail\n      });\n    };\n\n    _this.onClickTagAt = function (index) {\n      _this.deleteTagAt(index);\n    };\n\n    _this.onClickTagInputEnter = function (e) {\n      var tagInput = e.currentTarget;\n      var tag = tagInput.value;\n\n      _this.addTag(tag);\n\n      tagInput.value = \"\";\n    };\n\n    _this.onClickTagInpuBackspace = function (e) {\n      var tagInput = e.currentTarget;\n\n      if (tagInput.value === \"\") {\n        _this.deleteTagAtLast();\n      }\n    };\n\n    _this.onClickPopularTag = function (popularTag) {\n      _this.addTag(popularTag);\n    };\n\n    _this.onChangeName = function (e) {\n      _this.setState({\n        name: e.currentTarget.value,\n        isWarningName: false\n      });\n    };\n\n    _this.onChangeDescription = function (e) {\n      _this.setState({\n        description: e.currentTarget.value,\n        isWarningDescription: false\n      });\n    };\n\n    _this.onChangeIsCopyAllowed = function (e) {\n      _this.setState(function (prevState) {\n        return {\n          isCopyAllowed: !prevState.isCopyAllowed\n        };\n      });\n    };\n\n    _this.onClickOverlay = function () {\n      _this.props.setIsPublishOn(false);\n    };\n\n    _this.onClickClose = function () {\n      _this.props.setIsPublishOn(false);\n    };\n\n    _this.state = {\n      name: \"\",\n      description: \"\",\n      icon: null,\n      isCopyAllowed: true,\n      tags: [],\n      popularTags: [],\n      didPublish: false,\n      isWarningName: false,\n      isWarningDescription: false\n    };\n    _this.isUsingGameThumbnail = !props.useCustomIcon;\n    return _this;\n  }\n\n  _createClass(Container, [{\n    key: \"componentDidMount\",\n    value: function componentDidMount() {\n      var pId = this.props.pId;\n      this.loadPublishedProject(pId);\n      this.loadPopularTags();\n    }\n  }, {\n    key: \"loadPublishedProject\",\n    value: function loadPublishedProject(pId) {\n      var _this2 = this;\n\n      this.getPublishedProject(pId, function (published) {\n        if (published) {\n          var name = published.name,\n              description = published.description,\n              isCopyAllowed = published.isCopyAllowed,\n              tag = published.tag;\n          var icon = _this2.isUsingGameThumbnail ? _this2.props.gameThumbnail : published.icon;\n          var tags = tag.map(function (item) {\n            return item.gameTag.name;\n          });\n\n          _this2.setState({\n            name: name,\n            description: description,\n            icon: icon,\n            isCopyAllowed: isCopyAllowed,\n            tags: tags,\n            didPublish: true\n          });\n        }\n      });\n    }\n  }, {\n    key: \"getPublishedProject\",\n    value: function getPublishedProject(pId, callback) {\n      request.getPublishedProject({\n        pId: pId\n      }).then(function (res) {\n        return res.json();\n      }).then(function (published) {\n        if (callback) callback(published);\n      }).catch(function (e) {\n        return console.error(e);\n      });\n    }\n  }, {\n    key: \"loadPopularTags\",\n    value: function loadPopularTags() {\n      var _this3 = this;\n\n      this.getPopularTags(function (popularTags) {\n        _this3.setState({\n          popularTags: popularTags\n        });\n      });\n    }\n  }, {\n    key: \"getPopularTags\",\n    value: function getPopularTags(callback) {\n      request.getPopularTag().then(function (res) {\n        return res.json();\n      }).then(function (json) {\n        if (callback) {\n          var popularTags = json.map(function (item) {\n            return item.name;\n          });\n          callback(popularTags);\n        }\n      }).catch(function (e) {\n        return console.error(e);\n      });\n    }\n  }, {\n    key: \"componentDidUpdate\",\n    value: function componentDidUpdate(prevProps) {\n      if (prevProps.isPublishOn !== this.props.isPublishOn) {\n        this.onUpdateIsPublishOn();\n      }\n\n      if (prevProps.gameThumbnail !== this.props.gameThumbnail) {\n        this.onChangeGameThumbnail();\n      }\n    }\n  }, {\n    key: \"onUpdateIsPublishOn\",\n    value: function onUpdateIsPublishOn() {\n      if (this.props.isPublishOn) {\n        var pId = this.props.pId;\n        this.loadPublishedProject(pId);\n        this.setState({\n          isWarningName: false,\n          isWarningDescription: false\n        });\n      }\n    }\n  }, {\n    key: \"onChangeGameThumbnail\",\n    value: function onChangeGameThumbnail() {\n      if (this.isUsingGameThumbnail) {\n        this.setState({\n          icon: this.props.gameThumbnail\n        });\n      }\n    }\n  }, {\n    key: \"publish\",\n    value: function () {\n      var _publish = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee2(onpublish) {\n        var gameSrc, url, params;\n        return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                _context2.next = 2;\n                return generateBabylonPage({\n                  gameData: this.props.game,\n                  isBuilderPlay: false\n                });\n\n              case 2:\n                gameSrc = _context2.sent;\n                _context2.next = 5;\n                return request.uploadPublished({\n                  doc: gameSrc\n                }).then(function (res) {\n                  return res.json();\n                }).then(function (json) {\n                  return json.url;\n                }).catch(function (err) {\n                  console.error(err);\n                });\n\n              case 5:\n                url = _context2.sent;\n\n                if (url) {\n                  _context2.next = 8;\n                  break;\n                }\n\n                return _context2.abrupt(\"return\");\n\n              case 8:\n                params = {\n                  pId: this.props.pId,\n                  email: this.props.email,\n                  name: this.state.name,\n                  description: this.state.description,\n                  icon: this.state.icon,\n                  isCopyAllowed: this.state.isCopyAllowed,\n                  tags: this.state.tags,\n                  url: url,\n                  category: \"Game\",\n                  copyStateFromDev: true,\n                  live: true\n                };\n                request.postPublishedProject(params).then(function (res) {\n                  return res.json();\n                }).then(function (published) {\n                  if (onpublish) {\n                    onpublish(published);\n                  }\n                });\n\n              case 10:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2, this);\n      }));\n\n      function publish(_x2) {\n        return _publish.apply(this, arguments);\n      }\n\n      return publish;\n    }()\n  }, {\n    key: \"updateDevelopingProjectIcon\",\n    value: function updateDevelopingProjectIcon() {\n      var icon = this.state.icon;\n      var _this$props = this.props,\n          pId = _this$props.pId,\n          gameThumbnail = _this$props.gameThumbnail;\n      var useCustomIcon = icon !== gameThumbnail;\n      var params = {\n        pId: pId,\n        icon: icon,\n        useCustomIcon: useCustomIcon\n      };\n      request.postDevelopingProject(params);\n      this.isUsingGameThumbnail = !useCustomIcon;\n    }\n  }, {\n    key: \"checkAllFieldValid\",\n    value: function checkAllFieldValid() {\n      var isNameValid = this.checkNameValid();\n      var isDescValid = this.checkDescriptionValid();\n      return isNameValid && isDescValid;\n    }\n  }, {\n    key: \"checkNameValid\",\n    value: function checkNameValid() {\n      var name = this.state.name;\n\n      if (!name) {\n        this.setState({\n          isWarningName: true\n        });\n        return false;\n      }\n\n      return true;\n    }\n  }, {\n    key: \"checkDescriptionValid\",\n    value: function checkDescriptionValid() {\n      var description = this.state.description;\n\n      if (!description) {\n        this.setState({\n          isWarningDescription: true\n        });\n        return false;\n      }\n\n      return true;\n    }\n  }, {\n    key: \"addTag\",\n    value: function addTag(_tag) {\n      if (!_tag) return;\n\n      var tag = _tag.trim().substring(0, 10);\n\n      if (!tag) return;\n      var tags = this.state.tags;\n      if (tags.indexOf(tag) >= 0) return;\n      this.setState({\n        tags: [].concat(tags, tag)\n      }, function () {\n        console.log(111, tags, tag);\n      });\n    }\n  }, {\n    key: \"deleteTagAt\",\n    value: function deleteTagAt(index) {\n      var tags = _toConsumableArray(this.state.tags);\n\n      tags.splice(index, 1);\n      this.setState({\n        tags: tags\n      });\n    }\n  }, {\n    key: \"deleteTagAtLast\",\n    value: function deleteTagAtLast() {\n      var tags = this.state.tags;\n\n      if (tags.length > 0) {\n        this.deleteTagAt(tags.length - 1);\n      }\n    }\n  }, {\n    key: \"render\",\n    value: function render() {\n      var isPublishOn = this.props.isPublishOn;\n      var isHidden = !isPublishOn;\n      return React.createElement(View, Object.assign({\n        isHidden: isHidden\n      }, this.state, {\n        onClickOverlay: this.onClickOverlay,\n        onClickClose: this.onClickClose,\n        onClickPublish: this.onClickPublish,\n        onChangeName: this.onChangeName,\n        onChangeDescription: this.onChangeDescription,\n        onChangeIsCopyAllowed: this.onChangeIsCopyAllowed,\n        handleIconChange: this.handleIconChange,\n        onClickIconChange: this.onClickIconChange,\n        onClickIconDelete: this.onClickIconDelete,\n        onClickTagAt: this.onClickTagAt,\n        onClickTagInputEnter: this.onClickTagInputEnter,\n        onClickTagInpuBackspace: this.onClickTagInpuBackspace,\n        onClickPopularTag: this.onClickPopularTag,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 271\n        },\n        __self: this\n      }));\n    }\n  }]);\n\n  return Container;\n}(Component);\n\nexport default connect(function (state) {\n  var userinfo = state.userinfo,\n      project = state.project,\n      builder = state.builder,\n      game = state.game;\n  var email = userinfo.email;\n\n  var _ref2 = project || {},\n      pId = _ref2.pId,\n      useCustomIcon = _ref2.useCustomIcon;\n\n  var isPublishOn = builder.isPublishOn;\n  var gameThumbnail = game.thumbnail;\n  return {\n    email: email,\n    pId: pId,\n    useCustomIcon: useCustomIcon,\n    project: project,\n    game: game,\n    gameThumbnail: gameThumbnail,\n    isPublishOn: isPublishOn\n  };\n}, {\n  setIsPublishOn: builderAction.setIsPublishOn\n})(injectIntl(Container));","map":{"version":3,"sources":["/Users/jimmy/Documents/Wizschool/wizlab_web2/src/Page/Builder3D/Component/Publish/Container.js"],"names":["React","Component","connect","injectIntl","request","ImageCompressor","generateBabylonPage","builderAction","View","Container","props","onClickPublish","checkAllFieldValid","publish","updateDevelopingProjectIcon","alert","setIsPublishOn","handleIconChange","e","selectedFile","target","files","data","FormData","compressed","append","upload","then","res","json","url","catch","err","console","error","icon","setState","gameThumbnail","onClickIconChange","fileInput","document","getElementById","click","onClickIconDelete","onClickTagAt","index","deleteTagAt","onClickTagInputEnter","tagInput","currentTarget","tag","value","addTag","onClickTagInpuBackspace","deleteTagAtLast","onClickPopularTag","popularTag","onChangeName","name","isWarningName","onChangeDescription","description","isWarningDescription","onChangeIsCopyAllowed","prevState","isCopyAllowed","onClickOverlay","onClickClose","state","tags","popularTags","didPublish","isUsingGameThumbnail","useCustomIcon","pId","loadPublishedProject","loadPopularTags","getPublishedProject","published","map","item","gameTag","callback","getPopularTags","getPopularTag","prevProps","isPublishOn","onUpdateIsPublishOn","onChangeGameThumbnail","onpublish","gameData","game","isBuilderPlay","gameSrc","uploadPublished","doc","params","email","category","copyStateFromDev","live","postPublishedProject","postDevelopingProject","isNameValid","checkNameValid","isDescValid","checkDescriptionValid","_tag","trim","substring","indexOf","concat","log","splice","length","isHidden","userinfo","project","builder","thumbnail"],"mappings":"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","sourcesContent":["import React, { Component } from \"react\";\nimport { connect } from \"react-redux\";\nimport { injectIntl } from \"react-intl\";\nimport * as request from \"../../../../Common/Util/HTTPRequest\";\nimport { ImageCompressor } from \"../../../../Common/Util/FileCompressor\";\nimport { generateBabylonPage } from \"../../../Builder/utils/gamePageGenerator\";\nimport * as builderAction from \"../../Store/Reducer/builder\";\nimport View from \"./View\";\n\nclass Container extends Component {\n  constructor(props) {\n    super(props);\n    this.state = {\n      name: \"\",\n      description: \"\",\n      icon: null,\n      isCopyAllowed: true,\n      tags: [],\n      popularTags: [],\n      didPublish: false,\n      isWarningName: false,\n      isWarningDescription: false,\n    };\n    this.isUsingGameThumbnail = !props.useCustomIcon;\n  }\n  componentDidMount() {\n    const { pId } = this.props;\n    this.loadPublishedProject(pId);\n    this.loadPopularTags();\n  }\n  loadPublishedProject(pId) {\n    this.getPublishedProject(pId, (published) => {\n      if (published) {\n        const { name, description, isCopyAllowed, tag } = published;\n        const icon = this.isUsingGameThumbnail ? this.props.gameThumbnail : published.icon;\n        const tags = tag.map((item) => item.gameTag.name);\n        this.setState({\n          name,\n          description,\n          icon,\n          isCopyAllowed,\n          tags,\n          didPublish: true,\n        });\n      }\n    });\n  }\n  getPublishedProject(pId, callback) {\n    request\n      .getPublishedProject({ pId })\n      .then((res) => res.json())\n      .then((published) => {\n        if (callback) callback(published);\n      })\n      .catch((e) => console.error(e));\n  }\n  loadPopularTags() {\n    this.getPopularTags((popularTags) => {\n      this.setState({ popularTags });\n    });\n  }\n  getPopularTags(callback) {\n    request\n      .getPopularTag()\n      .then((res) => res.json())\n      .then((json) => {\n        if (callback) {\n          const popularTags = json.map((item) => item.name);\n          callback(popularTags);\n        }\n      })\n      .catch((e) => console.error(e));\n  }\n\n  componentDidUpdate(prevProps) {\n    if (prevProps.isPublishOn !== this.props.isPublishOn) {\n      this.onUpdateIsPublishOn();\n    }\n    if (prevProps.gameThumbnail !== this.props.gameThumbnail) {\n      this.onChangeGameThumbnail();\n    }\n  }\n  onUpdateIsPublishOn() {\n    if (this.props.isPublishOn) {\n      const { pId } = this.props;\n      this.loadPublishedProject(pId);\n      this.setState({ isWarningName: false, isWarningDescription: false });\n    }\n  }\n  onChangeGameThumbnail() {\n    if (this.isUsingGameThumbnail) {\n      this.setState({ icon: this.props.gameThumbnail });\n    }\n  }\n\n  onClickPublish = () => {\n    if (this.checkAllFieldValid()) {\n      this.publish(() => {\n        this.updateDevelopingProjectIcon();\n        alert(\"퍼블리싱되었습니다 :)\");\n        this.props.setIsPublishOn(false);\n      });\n    }\n  };\n  async publish(onpublish) {\n    const gameSrc = await generateBabylonPage({\n      gameData: this.props.game,\n      isBuilderPlay: false,\n    });\n    const url = await request\n      .uploadPublished({ doc: gameSrc })\n      .then((res) => res.json())\n      .then((json) => json.url)\n      .catch((err) => {\n        console.error(err);\n      });\n    if (!url) return;\n\n    const params = {\n      pId: this.props.pId,\n      email: this.props.email,\n      name: this.state.name,\n      description: this.state.description,\n      icon: this.state.icon,\n      isCopyAllowed: this.state.isCopyAllowed,\n      tags: this.state.tags,\n      url,\n      category: \"Game\",\n      copyStateFromDev: true,\n      live: true,\n    };\n\n    request\n      .postPublishedProject(params)\n      .then((res) => res.json())\n      .then((published) => {\n        if (onpublish) {\n          onpublish(published);\n        }\n      });\n  }\n  updateDevelopingProjectIcon() {\n    const { icon } = this.state;\n    const { pId, gameThumbnail } = this.props;\n    const useCustomIcon = icon !== gameThumbnail;\n    const params = { pId, icon, useCustomIcon };\n    request.postDevelopingProject(params);\n    this.isUsingGameThumbnail = !useCustomIcon;\n  }\n  checkAllFieldValid() {\n    const isNameValid = this.checkNameValid();\n    const isDescValid = this.checkDescriptionValid();\n    return isNameValid && isDescValid;\n  }\n  checkNameValid() {\n    const { name } = this.state;\n    if (!name) {\n      this.setState({ isWarningName: true });\n      return false;\n    }\n    return true;\n  }\n  checkDescriptionValid() {\n    const { description } = this.state;\n    if (!description) {\n      this.setState({ isWarningDescription: true });\n      return false;\n    }\n    return true;\n  }\n\n  handleIconChange = async (e) => {\n    const selectedFile = e.target.files[0];\n    if (!selectedFile) return;\n\n    const data = new FormData();\n    let compressed = await ImageCompressor(selectedFile);\n    data.append(\"file\", compressed);\n\n    const icon = await request\n      .upload(data)\n      .then((res) => res.json())\n      .then((json) => json.url)\n      .catch((err) => {\n        console.error(err);\n      });\n\n    if (icon) {\n      this.setState({ icon });\n    } else {\n      this.setState({ icon: this.props.gameThumbnail });\n    }\n  };\n  onClickIconChange = () => {\n    const fileInput = document.getElementById(\"iconFileInput\");\n    if (fileInput) {\n      fileInput.click();\n    }\n  };\n  onClickIconDelete = () => {\n    this.setState({ icon: this.props.gameThumbnail });\n  };\n\n  onClickTagAt = (index) => {\n    this.deleteTagAt(index);\n  };\n  onClickTagInputEnter = (e) => {\n    const tagInput = e.currentTarget;\n    const tag = tagInput.value;\n    this.addTag(tag);\n    tagInput.value = \"\";\n  };\n  onClickTagInpuBackspace = (e) => {\n    const tagInput = e.currentTarget;\n    if (tagInput.value === \"\") {\n      this.deleteTagAtLast();\n    }\n  };\n  onClickPopularTag = (popularTag) => {\n    this.addTag(popularTag);\n  };\n  addTag(_tag) {\n    if (!_tag) return;\n\n    let tag = _tag.trim().substring(0, 10);\n    if (!tag) return;\n\n    const { tags } = this.state;\n    if (tags.indexOf(tag) >= 0) return;\n\n    this.setState({ tags: [].concat(tags, tag) }, () => {\n      console.log(111, tags, tag);\n    });\n  }\n  deleteTagAt(index) {\n    const tags = [...this.state.tags];\n    tags.splice(index, 1);\n    this.setState({ tags });\n  }\n  deleteTagAtLast() {\n    const { tags } = this.state;\n    if (tags.length > 0) {\n      this.deleteTagAt(tags.length - 1);\n    }\n  }\n\n  onChangeName = (e) => {\n    this.setState({ name: e.currentTarget.value, isWarningName: false });\n  };\n  onChangeDescription = (e) => {\n    this.setState({\n      description: e.currentTarget.value,\n      isWarningDescription: false,\n    });\n  };\n  onChangeIsCopyAllowed = (e) => {\n    this.setState((prevState) => ({ isCopyAllowed: !prevState.isCopyAllowed }));\n  };\n\n  onClickOverlay = () => {\n    this.props.setIsPublishOn(false);\n  };\n  onClickClose = () => {\n    this.props.setIsPublishOn(false);\n  };\n\n  render() {\n    const { isPublishOn } = this.props;\n    const isHidden = !isPublishOn;\n    return (\n      <View\n        isHidden={isHidden}\n        {...this.state}\n        onClickOverlay={this.onClickOverlay}\n        onClickClose={this.onClickClose}\n        onClickPublish={this.onClickPublish}\n        onChangeName={this.onChangeName}\n        onChangeDescription={this.onChangeDescription}\n        onChangeIsCopyAllowed={this.onChangeIsCopyAllowed}\n        handleIconChange={this.handleIconChange}\n        onClickIconChange={this.onClickIconChange}\n        onClickIconDelete={this.onClickIconDelete}\n        onClickTagAt={this.onClickTagAt}\n        onClickTagInputEnter={this.onClickTagInputEnter}\n        onClickTagInpuBackspace={this.onClickTagInpuBackspace}\n        onClickPopularTag={this.onClickPopularTag}\n      />\n    );\n  }\n}\n\nexport default connect(\n  (state) => {\n    const { userinfo, project, builder, game } = state;\n    const { email } = userinfo;\n    const { pId, useCustomIcon } = project || {};\n    const { isPublishOn } = builder;\n    const gameThumbnail = game.thumbnail;\n    return {\n      email,\n      pId,\n      useCustomIcon,\n      project,\n      game,\n      gameThumbnail,\n      isPublishOn,\n    };\n  },\n  { setIsPublishOn: builderAction.setIsPublishOn }\n)(injectIntl(Container));\n"]},"metadata":{},"sourceType":"module"}