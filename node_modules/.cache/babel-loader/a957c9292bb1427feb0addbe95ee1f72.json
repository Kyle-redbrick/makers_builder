{"ast":null,"code":"import _objectWithoutProperties from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectWithoutProperties\";\nimport _objectSpread from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread\";\nimport _classCallCheck from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";\nimport _inherits from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/inherits\";\nimport _possibleConstructorReturn from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/getPrototypeOf\";\nvar _jsxFileName = \"/Users/jimmy/Documents/Wizschool/wizlab_web2/src/Page/Builder/Component/Socket/Container.js\";\n\nfunction _createSuper(Derived) { var hasNativeReflectConstruct = _isNativeReflectConstruct(); return function _createSuperInternal() { var Super = _getPrototypeOf(Derived), result; if (hasNativeReflectConstruct) { var NewTarget = _getPrototypeOf(this).constructor; result = Reflect.construct(Super, arguments, NewTarget); } else { result = Super.apply(this, arguments); } return _possibleConstructorReturn(this, result); }; }\n\nfunction _isNativeReflectConstruct() { if (typeof Reflect === \"undefined\" || !Reflect.construct) return false; if (Reflect.construct.sham) return false; if (typeof Proxy === \"function\") return true; try { Boolean.prototype.valueOf.call(Reflect.construct(Boolean, [], function () {})); return true; } catch (e) { return false; } }\n\nimport React, { Component } from \"react\";\nimport { connect } from \"react-redux\";\nimport io from \"socket.io-client\"; // import uuidv4 from \"uuid/v4\";\n\nimport { URL, PAGETYPE } from \"../../../../Common/Util/Constant\";\nimport * as socketActions from \"../../Store/Reducer/socket\";\nimport * as chatActions from \"../../Store/Reducer/chat\";\nimport { showPopUp } from \"../../../../Common/Component/PopUp\"; // import { FormattedMessage } from \"react-intl\";\n\nimport { setMyProject } from \"../MultiSocket/Container\"; // import AssetLibrary from \"../../utils/assetLibrary\";\n\nvar socket = io(URL.SOCKET_SERVER, {});\nexport var socketUtil = {// socket: socket,\n  // sendSocketEvent: (event, data = {}) => {\n  //   socket.emit(event, data);\n  // }\n};\n\nvar Container = /*#__PURE__*/function (_Component) {\n  _inherits(Container, _Component);\n\n  var _super = _createSuper(Container);\n\n  //chat\n  function Container(props) {\n    var _this;\n\n    _classCallCheck(this, Container);\n\n    _this = _super.call(this, props);\n    _this.socketTimer = undefined;\n    _this.EVENT_CONNECT = \"connect\";\n    _this.EVENT_JOIN = \"join\";\n    _this.EVENT_JOIN_ROOM = \"joinRoom\";\n    _this.EVENT_INSTANT_RUN_ACK = \"instantRunAck\";\n    _this.EVENT_INSTANT_RUN = \"instantRun\";\n    _this.EVENT_STATE = _this.props.pageType === PAGETYPE.WIZLIVE_1V4 ? \"multiState\" : \"state\";\n    _this.EVENT_STATE_TUTORIAL = \"stateTutorial\";\n    _this.EVENT_REQUEST_IMAGE = \"requestImage\";\n    _this.EVENT_RESPONSE_IMAGE = \"responseImage\";\n    _this.EVENT_TIMER = _this.props.pageType === PAGETYPE.WIZLIVE_1V4 ? 500 : 2000;\n    _this.EVENT_MULTI_STATE = \"multiState\";\n    _this.EVENT_LEAVE = \"leave\";\n    _this.EVENT_HIGHLIGHT = \"highlight\";\n    _this.EVENT_CHAT_MESSAGE = \"chatMessage\";\n\n    _this.setSocket = function () {\n      // const options = {}; //options reference : https://socket.io/docs/client-api/#new-Manager-url-options\n      _this.socket = socket;\n      var roomId = \"all\";\n\n      if (_this.props.pageType === PAGETYPE.WIZLIVE_1V4) {\n        roomId = _this.props.roomId;\n      }\n\n      if (_this.props.email) {\n        _this.socket.emit(_this.EVENT_JOIN, {\n          email: _this.props.email\n        });\n      }\n\n      _this.socket.emit(_this.EVENT_JOIN_ROOM, {\n        roomId: roomId\n      }); // global chat room\n\n\n      _this.joinedRoom.push(roomId);\n\n      _this.socket.on(_this.EVENT_INSTANT_RUN_ACK, function (data) {\n        setTimeout(function () {\n          showPopUp(null);\n        }, 1000);\n      });\n\n      _this.socket.on(_this.EVENT_RESPONSE_IMAGE, function (data) {\n        _this.props.setResponseImage(data.url);\n\n        _this.props.setRequestImage(false);\n      });\n    };\n\n    var pageType = props.pageType;\n    _this.codeSync = pageType !== PAGETYPE.VIDEOCLASS && pageType !== PAGETYPE.OCP && pageType !== PAGETYPE.TUTORIAL && pageType !== PAGETYPE.MONITOR && pageType !== PAGETYPE.QNA_READONLY && pageType !== PAGETYPE.BUILDER_READONLY;\n    _this.isTutorial = pageType === PAGETYPE.TUTORIAL;\n    _this.joinedRoom = [];\n    _this.currentUser = null;\n    return _this;\n  }\n\n  _createClass(Container, [{\n    key: \"componentDidMount\",\n    value: function componentDidMount() {\n      this.setSocket();\n    }\n  }, {\n    key: \"shouldComponentUpdate\",\n    value: function shouldComponentUpdate(nextProps, nextState) {\n      if (this.props.email) {\n        if (this.props.instantRunURL !== nextProps.instantRunURL) {\n          this.socket.emit(this.EVENT_INSTANT_RUN, {\n            email: this.props.email,\n            url: nextProps.instantRunURL\n          });\n          return false;\n        }\n\n        if (this.props.requestImage !== nextProps.requestImage) {\n          if (nextProps.requestImage === true) {\n            this.socket.emit(this.EVENT_REQUEST_IMAGE, {\n              email: this.props.email\n            });\n          }\n        }\n      }\n\n      return true;\n    }\n  }, {\n    key: \"componentDidUpdate\",\n    value: function componentDidUpdate(prevProps) {\n      var _this2 = this;\n\n      // chatting\n      if (this.props.messageQueue.length > 0) {\n        this.props.messageQueue.forEach(function (msg) {\n          var _msg = msg;\n\n          if (_this2.props.pageType === PAGETYPE.WIZLIVE_1V4) {\n            _msg = _objectSpread({}, _msg, {\n              roomId: _this2.props.roomId\n            });\n          }\n\n          _this2.socket.emit(_this2.EVENT_CHAT_MESSAGE, _msg);\n        });\n        this.props.clearMsgQueue();\n      } // code sync\n\n\n      if (!this.props.email) {\n        return;\n      }\n\n      if (this.codeSync) {\n        if (this.socketTimer) {\n          clearTimeout(this.socketTimer);\n        }\n\n        this.socketTimer = setTimeout(function () {\n          var _this2$props = _this2.props,\n              pId = _this2$props.pId,\n              scene = _this2$props.scene,\n              interaction = _this2$props.interaction,\n              preview = _this2$props.preview;\n          var state = JSON.stringify({\n            scene: scene,\n            interaction: _objectSpread({}, interaction, {\n              isPublished: undefined\n            }),\n            preview: _objectSpread({}, preview, {\n              isPlaying: false\n            })\n          });\n          var data = {\n            pId: pId,\n            state: state,\n            email: _this2.props.email\n          };\n\n          if (_this2.isTutorial) {\n            var scenes = scene.scenes;\n            var _this2$props2 = _this2.props,\n                selectedSceneId = _this2$props2.selectedSceneId,\n                selectedObject = _this2$props2.selectedObject;\n            var _sprite = scenes[selectedSceneId].sprites[selectedObject.name];\n\n            _this2.socket.emit(_this2.EVENT_STATE_TUTORIAL, {\n              email: _this2.props.email,\n              code: _sprite.code\n            });\n          } else {\n            // 1:4 수업\n            if (_this2.props.pageType === PAGETYPE.WIZLIVE_1V4) {\n              if (_this2.props.currentUser.email === _this2.props.email) {\n                // console.log(\n                //   3333,\n                //   \" ---- Set My Project to localStorage : \" +\n                //     this.props.currentUser.email\n                // );\n                setMyProject({\n                  scene: scene,\n                  interaction: interaction,\n                  preview: preview\n                }); // console.log(\n                //   3333,\n                //   `sending ${\n                //     this.props.currentUser.email\n                //   }'s project state --- socket event: ${this.EVENT_STATE} `\n                // );\n\n                _this2.socket.emit(_this2.EVENT_STATE, data);\n              } // 1:1 수업\n\n            } else {\n              _this2.socket.emit(_this2.EVENT_STATE, data);\n            }\n          }\n        }, this.EVENT_TIMER);\n      } else if (this.isTutorial) {// const { pId, scene, interaction, preview } = this.props;\n        // const state = JSON.stringify({\n        //   scene,\n        //   interaction: { ...interaction, isPublished: undefined },\n        //   preview: { ...preview, isPlaying: false }\n        // });\n        // const data = { pId, state };\n        // if (this.isTutorial) {\n        //   const { scenes } = scene;\n        //   const { selectedSceneId, selectedObject } = this.props;\n        //   const _sprite = scenes[selectedSceneId].sprites[selectedObject.name];\n        //   if (!_sprite) return;\n        //   const _code = _sprite.code;\n        //   if (this.lastSentCode === _code) {\n        //     return;\n        //   }\n        //   this.lastSentCode = _code;\n        //   this.socket.emit(this.EVENT_STATE_TUTORIAL, {\n        //     email: this.props.email,\n        //     code: _sprite.code\n        //   });\n        // } else {\n        //   this.socket.emit(this.EVENT_STATE, data);\n        // }\n      }\n\n      if (this.props.pageType === PAGETYPE.WIZLIVE_1V4) return;\n\n      if (this.joinedRoom.length !== Object.keys(this.props.rooms).length) {\n        Object.keys(this.props.rooms).forEach(function (roomId) {\n          if (_this2.joinedRoom.indexOf(roomId) === -1) {\n            _this2.socket.emit(_this2.EVENT_JOIN_ROOM, {\n              roomId: roomId\n            });\n\n            _this2.joinedRoom.push(roomId);\n          }\n        });\n      }\n    }\n  }, {\n    key: \"componentWillUnmount\",\n    value: function componentWillUnmount() {\n      this.socket.off(this.EVENT_INSTANT_RUN_ACK);\n      this.socket.off(this.EVENT_RESPONSE_IMAGE);\n      this.socket.off(this.EVENT_CHAT_MESSAGE);\n      this.socket.disconnect();\n    }\n  }, {\n    key: \"render\",\n    value: function render() {\n      return React.createElement(\"div\", {\n        style: {\n          display: \"none\"\n        },\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 216\n        },\n        __self: this\n      });\n    }\n  }]);\n\n  return Container;\n}(Component);\n\nexport default connect(function (state) {\n  var _state$scene = state.scene,\n      history = _state$scene.history,\n      historyIndex = _state$scene.historyIndex,\n      _scene = _objectWithoutProperties(_state$scene, [\"history\", \"historyIndex\"]);\n\n  return {\n    selectedSceneId: state.interaction.selected.scene,\n    selectedObject: state.interaction.selected.objects[state.interaction.selected.scene],\n    pId: state.project.pId,\n    scene: _scene,\n    interaction: _objectSpread({}, state.interaction, {\n      jukebox: {\n        isPlaying: false\n      },\n      addSoundsTimeStamp: undefined\n    }),\n    preview: state.preview,\n    email: state.userinfo.email,\n    project: state.project,\n    instantRunURL: state.socket.url,\n    requestImage: state.socket.requestImage,\n    messageQueue: state.chat.messageQueue,\n    rooms: state.chat.rooms,\n    currentUser: state.tabs.currentUser\n  };\n}, {\n  setRequestImage: socketActions.setRequestImage,\n  setResponseImage: socketActions.setResponseImage,\n  clearMsgQueue: chatActions.clearMsgQueue,\n  addMsg: chatActions.addMsg,\n  addUnreadMsgCount: chatActions.addUnreadMsgCount\n})(Container);","map":{"version":3,"sources":["/Users/jimmy/Documents/Wizschool/wizlab_web2/src/Page/Builder/Component/Socket/Container.js"],"names":["React","Component","connect","io","URL","PAGETYPE","socketActions","chatActions","showPopUp","setMyProject","socket","SOCKET_SERVER","socketUtil","Container","props","socketTimer","undefined","EVENT_CONNECT","EVENT_JOIN","EVENT_JOIN_ROOM","EVENT_INSTANT_RUN_ACK","EVENT_INSTANT_RUN","EVENT_STATE","pageType","WIZLIVE_1V4","EVENT_STATE_TUTORIAL","EVENT_REQUEST_IMAGE","EVENT_RESPONSE_IMAGE","EVENT_TIMER","EVENT_MULTI_STATE","EVENT_LEAVE","EVENT_HIGHLIGHT","EVENT_CHAT_MESSAGE","setSocket","roomId","email","emit","joinedRoom","push","on","data","setTimeout","setResponseImage","url","setRequestImage","codeSync","VIDEOCLASS","OCP","TUTORIAL","MONITOR","QNA_READONLY","BUILDER_READONLY","isTutorial","currentUser","nextProps","nextState","instantRunURL","requestImage","prevProps","messageQueue","length","forEach","msg","_msg","clearMsgQueue","clearTimeout","pId","scene","interaction","preview","state","JSON","stringify","isPublished","isPlaying","scenes","selectedSceneId","selectedObject","_sprite","sprites","name","code","Object","keys","rooms","indexOf","off","disconnect","display","history","historyIndex","_scene","selected","objects","project","jukebox","addSoundsTimeStamp","userinfo","chat","tabs","addMsg","addUnreadMsgCount"],"mappings":"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","sourcesContent":["import React, { Component } from \"react\";\nimport { connect } from \"react-redux\";\nimport io from \"socket.io-client\";\n// import uuidv4 from \"uuid/v4\";\nimport { URL, PAGETYPE } from \"../../../../Common/Util/Constant\";\nimport * as socketActions from \"../../Store/Reducer/socket\";\nimport * as chatActions from \"../../Store/Reducer/chat\";\nimport { showPopUp } from \"../../../../Common/Component/PopUp\";\n// import { FormattedMessage } from \"react-intl\";\nimport { setMyProject } from \"../MultiSocket/Container\";\n// import AssetLibrary from \"../../utils/assetLibrary\";\n\nconst socket = io(URL.SOCKET_SERVER, {});\nexport const socketUtil = {\n  // socket: socket,\n  // sendSocketEvent: (event, data = {}) => {\n  //   socket.emit(event, data);\n  // }\n};\n\nclass Container extends Component {\n  socketTimer = undefined;\n  EVENT_CONNECT = \"connect\";\n  EVENT_JOIN = \"join\";\n  EVENT_JOIN_ROOM = \"joinRoom\";\n  EVENT_INSTANT_RUN_ACK = \"instantRunAck\";\n  EVENT_INSTANT_RUN = \"instantRun\";\n  EVENT_STATE =\n    this.props.pageType === PAGETYPE.WIZLIVE_1V4 ? \"multiState\" : \"state\";\n  EVENT_STATE_TUTORIAL = \"stateTutorial\";\n  EVENT_REQUEST_IMAGE = \"requestImage\";\n  EVENT_RESPONSE_IMAGE = \"responseImage\";\n  EVENT_TIMER = this.props.pageType === PAGETYPE.WIZLIVE_1V4 ? 500 : 2000;\n  EVENT_MULTI_STATE = \"multiState\";\n  EVENT_LEAVE = \"leave\";\n  EVENT_HIGHLIGHT = \"highlight\";\n  //chat\n  EVENT_CHAT_MESSAGE = \"chatMessage\";\n\n  constructor(props) {\n    super(props);\n    const { pageType } = props;\n    this.codeSync =\n      pageType !== PAGETYPE.VIDEOCLASS &&\n      pageType !== PAGETYPE.OCP &&\n      pageType !== PAGETYPE.TUTORIAL &&\n      pageType !== PAGETYPE.MONITOR &&\n      pageType !== PAGETYPE.QNA_READONLY &&\n      pageType !== PAGETYPE.BUILDER_READONLY;\n    this.isTutorial = pageType === PAGETYPE.TUTORIAL;\n    this.joinedRoom = [];\n    this.currentUser = null;\n  }\n\n  componentDidMount() {\n    this.setSocket();\n  }\n\n  shouldComponentUpdate(nextProps, nextState) {\n    if (this.props.email) {\n      if (this.props.instantRunURL !== nextProps.instantRunURL) {\n        this.socket.emit(this.EVENT_INSTANT_RUN, {\n          email: this.props.email,\n          url: nextProps.instantRunURL\n        });\n        return false;\n      }\n\n      if (this.props.requestImage !== nextProps.requestImage) {\n        if (nextProps.requestImage === true) {\n          this.socket.emit(this.EVENT_REQUEST_IMAGE, {\n            email: this.props.email\n          });\n        }\n      }\n    }\n    return true;\n  }\n\n  componentDidUpdate(prevProps) {\n    // chatting\n    if (this.props.messageQueue.length > 0) {\n      this.props.messageQueue.forEach(msg => {\n        let _msg = msg;\n        if (this.props.pageType === PAGETYPE.WIZLIVE_1V4) {\n          _msg = { ..._msg, roomId: this.props.roomId };\n        }\n        this.socket.emit(this.EVENT_CHAT_MESSAGE, _msg);\n      });\n      this.props.clearMsgQueue();\n    }\n\n    // code sync\n    if (!this.props.email) {\n      return;\n    }\n    if (this.codeSync) {\n      if (this.socketTimer) {\n        clearTimeout(this.socketTimer);\n      }\n      this.socketTimer = setTimeout(() => {\n        const { pId, scene, interaction, preview } = this.props;\n        const state = JSON.stringify({\n          scene,\n          interaction: { ...interaction, isPublished: undefined },\n          preview: { ...preview, isPlaying: false }\n        });\n        const data = { pId, state, email: this.props.email };\n\n        if (this.isTutorial) {\n          const { scenes } = scene;\n          const { selectedSceneId, selectedObject } = this.props;\n          const _sprite = scenes[selectedSceneId].sprites[selectedObject.name];\n          this.socket.emit(this.EVENT_STATE_TUTORIAL, {\n            email: this.props.email,\n            code: _sprite.code\n          });\n        } else {\n          // 1:4 수업\n          if (this.props.pageType === PAGETYPE.WIZLIVE_1V4) {\n            if (this.props.currentUser.email === this.props.email) {\n              // console.log(\n              //   3333,\n              //   \" ---- Set My Project to localStorage : \" +\n              //     this.props.currentUser.email\n              // );\n              setMyProject({ scene, interaction, preview });\n\n              // console.log(\n              //   3333,\n              //   `sending ${\n              //     this.props.currentUser.email\n              //   }'s project state --- socket event: ${this.EVENT_STATE} `\n              // );\n              this.socket.emit(this.EVENT_STATE, data);\n            }\n            // 1:1 수업\n          } else {\n            this.socket.emit(this.EVENT_STATE, data);\n          }\n        }\n      }, this.EVENT_TIMER);\n    } else if (this.isTutorial) {\n      // const { pId, scene, interaction, preview } = this.props;\n      // const state = JSON.stringify({\n      //   scene,\n      //   interaction: { ...interaction, isPublished: undefined },\n      //   preview: { ...preview, isPlaying: false }\n      // });\n      // const data = { pId, state };\n      // if (this.isTutorial) {\n      //   const { scenes } = scene;\n      //   const { selectedSceneId, selectedObject } = this.props;\n      //   const _sprite = scenes[selectedSceneId].sprites[selectedObject.name];\n      //   if (!_sprite) return;\n      //   const _code = _sprite.code;\n      //   if (this.lastSentCode === _code) {\n      //     return;\n      //   }\n      //   this.lastSentCode = _code;\n      //   this.socket.emit(this.EVENT_STATE_TUTORIAL, {\n      //     email: this.props.email,\n      //     code: _sprite.code\n      //   });\n      // } else {\n      //   this.socket.emit(this.EVENT_STATE, data);\n      // }\n    }\n    if (this.props.pageType === PAGETYPE.WIZLIVE_1V4) return;\n\n    if (this.joinedRoom.length !== Object.keys(this.props.rooms).length) {\n      Object.keys(this.props.rooms).forEach(roomId => {\n        if (this.joinedRoom.indexOf(roomId) === -1) {\n          this.socket.emit(this.EVENT_JOIN_ROOM, { roomId });\n          this.joinedRoom.push(roomId);\n        }\n      });\n    }\n  }\n\n  componentWillUnmount() {\n    this.socket.off(this.EVENT_INSTANT_RUN_ACK);\n    this.socket.off(this.EVENT_RESPONSE_IMAGE);\n    this.socket.off(this.EVENT_CHAT_MESSAGE);\n    this.socket.disconnect();\n  }\n\n  setSocket = () => {\n    // const options = {}; //options reference : https://socket.io/docs/client-api/#new-Manager-url-options\n    this.socket = socket;\n    let roomId = \"all\";\n\n    if (this.props.pageType === PAGETYPE.WIZLIVE_1V4) {\n      roomId = this.props.roomId;\n    }\n\n    if (this.props.email) {\n      this.socket.emit(this.EVENT_JOIN, { email: this.props.email });\n    }\n\n    this.socket.emit(this.EVENT_JOIN_ROOM, { roomId }); // global chat room\n    this.joinedRoom.push(roomId);\n\n    this.socket.on(this.EVENT_INSTANT_RUN_ACK, data => {\n      setTimeout(() => {\n        showPopUp(null);\n      }, 1000);\n    });\n    this.socket.on(this.EVENT_RESPONSE_IMAGE, data => {\n      this.props.setResponseImage(data.url);\n      this.props.setRequestImage(false);\n    });\n  };\n\n  render() {\n    return <div style={{ display: \"none\" }} />;\n  }\n}\n\nexport default connect(\n  state => {\n    const { history, historyIndex, ..._scene } = state.scene;\n\n    return {\n      selectedSceneId: state.interaction.selected.scene,\n      selectedObject:\n        state.interaction.selected.objects[state.interaction.selected.scene],\n      pId: state.project.pId,\n      scene: _scene,\n      interaction: {\n        ...state.interaction,\n        jukebox: {\n          isPlaying: false\n        },\n        addSoundsTimeStamp: undefined\n      },\n      preview: state.preview,\n      email: state.userinfo.email,\n      project: state.project,\n      instantRunURL: state.socket.url,\n      requestImage: state.socket.requestImage,\n      messageQueue: state.chat.messageQueue,\n      rooms: state.chat.rooms,\n      currentUser: state.tabs.currentUser\n    };\n  },\n  {\n    setRequestImage: socketActions.setRequestImage,\n    setResponseImage: socketActions.setResponseImage,\n    clearMsgQueue: chatActions.clearMsgQueue,\n    addMsg: chatActions.addMsg,\n    addUnreadMsgCount: chatActions.addUnreadMsgCount\n  }\n)(Container);\n"]},"metadata":{},"sourceType":"module"}