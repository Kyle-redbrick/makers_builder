{"ast":null,"code":"import _regeneratorRuntime from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\nimport _classCallCheck from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";\nimport _possibleConstructorReturn from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/getPrototypeOf\";\nimport _inherits from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/inherits\";\nvar _jsxFileName = \"/Users/jimmy/Documents/Wizschool/wizlab_web2/src/Common/Component/UserInfo/index.js\";\nimport React from \"react\";\nimport QueryString from \"query-string\";\nimport { withRouter } from \"react-router-dom\";\nimport { URL } from \"../../Util/Constant.js\";\nimport { connect } from \"react-redux\";\nimport * as request from \"../../../Common/Util/HTTPRequest\";\nimport * as action from \"../../Store/Reducer/UserInfo\";\nimport * as OcpToken from \"../../Util/OcpToken\"; // import { showBingoPopup } from \"../../../Common/Component/PopUp/BingoPopup\";\n\nvar UserInfoContainer =\n/*#__PURE__*/\nfunction (_React$Component) {\n  _inherits(UserInfoContainer, _React$Component);\n\n  function UserInfoContainer(props) {\n    var _this;\n\n    _classCallCheck(this, UserInfoContainer);\n\n    _this = _possibleConstructorReturn(this, _getPrototypeOf(UserInfoContainer).call(this, props)); // console.log(\"UserInfoContainer constructor\", this.props);\n\n    _this.componentDidMount = function () {\n      window.addEventListener(\"focus\", _this.handleWindowFocus);\n      window.addEventListener(\"blur\", _this.handleWindowBlur);\n      window.addEventListener(\"message\", _this.onMessage, false);\n\n      _this.handleLoginTokenFromQuery();\n\n      if (!_this.shouldLogin) {\n        if (Object.keys(_this.props.userinfo).length === 0) {\n          _this.handleLoginByToken();\n        } else {\n          _this.setState({\n            mounted: true\n          });\n        }\n      } //check bingo event\n\n\n      _this.updateLastLoggedInTime();\n    };\n\n    _this.updateLastLoggedInTime = function () {\n      if (_this.props.userinfo.email) {\n        request.updateLastLoggedInTime({\n          email: _this.props.userinfo.email\n        }).then(function (res) {\n          return res.json();\n        }).then(function (json) {\n          if (json.success) {//for bingo\n            // this.checkUnreadBingoEvents();\n          }\n        }).catch(function (e) {\n          return console.error(e);\n        });\n      }\n    };\n\n    _this.onMessage = function (e) {\n      // console.log(\"UserInfoContainer onMessage\", e);\n      if (e.origin === URL.WIZLIVE || e.origin === URL.WIZLIVE_WWW) {\n        if (e.data.type === \"ready\") {\n          if (_this.liveIframe.current) {\n            _this.liveIframe.current.contentWindow.postMessage({\n              type: \"requestToken\"\n            }, \"*\");\n          }\n        } else if (e.data.type === \"token\") {\n          if (e.data.data) {\n            localStorage.setItem(\"wizToken\", e.data.data);\n\n            _this.handleLoginByToken();\n          } else {\n            _this.setState({\n              wizliveURL: URL.WIZLIVE_WWW\n            });\n          }\n        } else {// console.log(\"UserInfoContainer unknown data\", e.data);\n        }\n      }\n    };\n\n    _this.handleLoginByToken =\n    /*#__PURE__*/\n    function () {\n      var _ref = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee(e) {\n        var token, params, response, json, user;\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                token = localStorage.getItem(\"wizToken\"); // console.log(\"login by token\", token);\n\n                if (!token) {\n                  _context.next = 19;\n                  break;\n                }\n\n                params = {\n                  token: token\n                };\n                _context.prev = 3;\n                _context.next = 6;\n                return request.loginByToken(params);\n\n              case 6:\n                response = _context.sent;\n                _context.next = 9;\n                return response.json();\n\n              case 9:\n                json = _context.sent;\n\n                if (json.user) {\n                  user = json.user;\n                  user.payment = json.payment;\n                  localStorage.setItem(\"wizToken\", json.token);\n\n                  _this.props.updateUserInfo(user);\n\n                  _this.setState({\n                    mounted: true\n                  });\n                } else {\n                  // console.log(\"user not found\");\n                  // localStorage.removeItem(\"wizToken\");\n                  _this.props.updateUserInfo();\n\n                  _this.setState({\n                    mounted: true\n                  });\n                }\n\n                _context.next = 17;\n                break;\n\n              case 13:\n                _context.prev = 13;\n                _context.t0 = _context[\"catch\"](3);\n\n                // console.log(\"request failed\");\n                // localStorage.removeItem(\"wizToken\");\n                _this.props.updateUserInfo();\n\n                _this.setState({\n                  mounted: true\n                });\n\n              case 17:\n                _context.next = 21;\n                break;\n\n              case 19:\n                // console.log(\"token not found\");\n                // localStorage.removeItem(\"wizToken\");\n                _this.props.updateUserInfo();\n\n                _this.setState({\n                  mounted: true\n                });\n\n              case 21:\n                //for ocp\n                if (_this.props.match.path.split(\"/\")[1] === \"ocp2\" && _this.props.match.params.step === \"1\") {\n                  OcpToken.addOcpUser(_this.props.userinfo.email, _this.props.match.params.grade, _this.props.match.params.type ? _this.props.match.params.type : _this.props.match.path.split(\"/\")[2]);\n                }\n\n                OcpToken.updateOcpToken();\n\n              case 23:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this, [[3, 13]]);\n      }));\n\n      return function (_x) {\n        return _ref.apply(this, arguments);\n      };\n    }();\n\n    _this.handleWindowBlur = function (e) {\n      _this.windowFocused = false;\n    };\n\n    _this.handleWindowFocus = function (e) {\n      var isNeedUpdate = _this.windowFocused === false;\n      _this.windowFocused = true;\n      var token = localStorage.getItem(\"wizToken\");\n\n      if (token) {\n        var json = _this.parseJwt(token);\n\n        var tokenEmail = json.email;\n\n        if (tokenEmail !== _this.props.userinfo.email) {//window.location.reload();\n        } else {\n          if (isNeedUpdate) {// this.checkUnreadBingoEvents();\n          }\n        }\n      }\n\n      if (!token && Object.keys(_this.props.userinfo).length > 0) {\n        _this.props.updateUserInfo();\n      }\n    };\n\n    _this.state = {\n      mounted: false,\n      wizliveURL: URL.WIZLIVE\n    };\n    _this.showAlert = false;\n    _this.shouldLogin = _this.props.match.path === \"/wizlive/:pId\" || _this.props.match.path === \"/wizlive_1v4/:pId\" || _this.props.match.path === \"/builder_edit/:pId\" || _this.props.match.path === \"/builder_readonly/:pId\";\n    _this.liveToken = undefined;\n    _this.liveIframe = React.createRef();\n    _this.windowFocused = true;\n    return _this;\n  }\n\n  _createClass(UserInfoContainer, [{\n    key: \"shouldComponentUpdate\",\n    value: function shouldComponentUpdate(nextProps, nextState) {\n      this.showAlert = this.showAlert && this.state.mounted;\n\n      if (!this.props.userinfo.email && nextProps.userinfo.email) {\n        OcpToken.updateOcpTokenToEmail(nextProps.userinfo.email);\n      }\n\n      return true;\n    }\n  }, {\n    key: \"componentDidUpdate\",\n    value: function componentDidUpdate(prevProps) {\n      if (!prevProps.userinfo.email && this.props.userinfo.email) {\n        this.updateLastLoggedInTime();\n      }\n    }\n  }, {\n    key: \"componentWillUnmount\",\n    // checkUnreadBingoEvents = () => {\n    //   request\n    //     .getUnreadBingoEvents({ email: this.props.userinfo.email })\n    //     .then(res => res.json())\n    //     .then(json => {\n    //       if (json.myBingos && json.myBingos.length > 0) {\n    //         this.unreadBingos = json.myBingos;\n    //         this.showUnreadPopups();\n    //       }\n    //     })\n    //     .catch(e => console.error(e));\n    // };\n    // showUnreadPopups = () => {\n    //   if (this.unreadBingos && this.unreadBingos.length > 0) {\n    //     const unread = this.unreadBingos.shift();\n    //     const { email } = this.props.userinfo;\n    //     showBingoPopup(email, unread.bingoType, {\n    //       // confirmAction: () => {\n    //       //   this.showUnreadPopups();\n    //       // },\n    //       cancelAction: () => {\n    //         this.showUnreadPopups();\n    //       }\n    //     });\n    //   }\n    // };\n    value: function componentWillUnmount() {\n      window.removeEventListener(\"focus\", this.handleWindowFocus);\n      window.removeEventListener(\"blur\", this.handleWindowBlur);\n      window.removeEventListener(\"message\", this.onMessage);\n    }\n  }, {\n    key: \"parseJwt\",\n    value: function parseJwt(token) {\n      var base64Url = token.split(\".\")[1];\n      var base64 = base64Url.replace(/-/g, \"+\").replace(/_/g, \"/\");\n      return JSON.parse(window.atob(base64));\n    }\n  }, {\n    key: \"handleLoginTokenFromQuery\",\n    value: function handleLoginTokenFromQuery() {\n      var params = QueryString.parse(window.location.search);\n      var loginToken = params.loginToken;\n\n      if (loginToken) {\n        localStorage.setItem(\"wizToken\", loginToken);\n        var replaceUrl = window.location.href.split(\"?\")[0];\n        window.history.replaceState({}, undefined, replaceUrl);\n      }\n    }\n  }, {\n    key: \"render\",\n    value: function render() {\n      return React.createElement(React.Fragment, {\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 222\n        },\n        __self: this\n      }, this.state.mounted === true ? this.props.children : null, this.shouldLogin && React.createElement(\"iframe\", {\n        title: \"tokenIFrame\",\n        ref: this.liveIframe,\n        src: this.state.wizliveURL + \"/tokenIFrame\",\n        style: {\n          display: \"none\"\n        },\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 225\n        },\n        __self: this\n      }));\n    }\n  }]);\n\n  return UserInfoContainer;\n}(React.Component);\n\nexport default connect(function (state) {\n  return {\n    userinfo: state.userinfo\n  };\n}, {\n  updateUserInfo: action.updateUserInfo\n})(withRouter(UserInfoContainer));","map":{"version":3,"sources":["/Users/jimmy/Documents/Wizschool/wizlab_web2/src/Common/Component/UserInfo/index.js"],"names":["React","QueryString","withRouter","URL","connect","request","action","OcpToken","UserInfoContainer","props","componentDidMount","window","addEventListener","handleWindowFocus","handleWindowBlur","onMessage","handleLoginTokenFromQuery","shouldLogin","Object","keys","userinfo","length","handleLoginByToken","setState","mounted","updateLastLoggedInTime","email","then","res","json","success","catch","e","console","error","origin","WIZLIVE","WIZLIVE_WWW","data","type","liveIframe","current","contentWindow","postMessage","localStorage","setItem","wizliveURL","token","getItem","params","loginByToken","response","user","payment","updateUserInfo","match","path","split","step","addOcpUser","grade","updateOcpToken","windowFocused","isNeedUpdate","parseJwt","tokenEmail","state","showAlert","liveToken","undefined","createRef","nextProps","nextState","updateOcpTokenToEmail","prevProps","removeEventListener","base64Url","base64","replace","JSON","parse","atob","location","search","loginToken","replaceUrl","href","history","replaceState","children","display","Component"],"mappings":"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","sourcesContent":["import React from \"react\";\nimport QueryString from \"query-string\";\nimport { withRouter } from \"react-router-dom\";\nimport { URL } from \"../../Util/Constant.js\";\nimport { connect } from \"react-redux\";\nimport * as request from \"../../../Common/Util/HTTPRequest\";\nimport * as action from \"../../Store/Reducer/UserInfo\";\nimport * as OcpToken from \"../../Util/OcpToken\";\n// import { showBingoPopup } from \"../../../Common/Component/PopUp/BingoPopup\";\n\nclass UserInfoContainer extends React.Component {\n  constructor(props) {\n    super(props);\n    // console.log(\"UserInfoContainer constructor\", this.props);\n    this.state = { mounted: false, wizliveURL: URL.WIZLIVE };\n    this.showAlert = false;\n    this.shouldLogin =\n      this.props.match.path === \"/wizlive/:pId\" ||\n      this.props.match.path === \"/wizlive_1v4/:pId\" ||\n      this.props.match.path === \"/builder_edit/:pId\" ||\n      this.props.match.path === \"/builder_readonly/:pId\";\n    this.liveToken = undefined;\n    this.liveIframe = React.createRef();\n    this.windowFocused = true;\n  }\n\n  shouldComponentUpdate(nextProps, nextState) {\n    this.showAlert = this.showAlert && this.state.mounted;\n    if (!this.props.userinfo.email && nextProps.userinfo.email) {\n      OcpToken.updateOcpTokenToEmail(nextProps.userinfo.email);\n    }\n    return true;\n  }\n\n  componentDidMount = () => {\n    window.addEventListener(\"focus\", this.handleWindowFocus);\n    window.addEventListener(\"blur\", this.handleWindowBlur);\n    window.addEventListener(\"message\", this.onMessage, false);\n    this.handleLoginTokenFromQuery();\n\n    if (!this.shouldLogin) {\n      if (Object.keys(this.props.userinfo).length === 0) {\n        this.handleLoginByToken();\n      } else {\n        this.setState({ mounted: true });\n      }\n    }\n\n    //check bingo event\n    this.updateLastLoggedInTime();\n  };\n\n  componentDidUpdate(prevProps) {\n    if (!prevProps.userinfo.email && this.props.userinfo.email) {\n      this.updateLastLoggedInTime();\n    }\n  }\n\n  updateLastLoggedInTime = () => {\n    if (this.props.userinfo.email) {\n      request\n        .updateLastLoggedInTime({ email: this.props.userinfo.email })\n        .then(res => res.json())\n        .then(json => {\n          if (json.success) {\n            //for bingo\n            // this.checkUnreadBingoEvents();\n          }\n        })\n        .catch(e => console.error(e));\n    }\n  };\n\n  // checkUnreadBingoEvents = () => {\n  //   request\n  //     .getUnreadBingoEvents({ email: this.props.userinfo.email })\n  //     .then(res => res.json())\n  //     .then(json => {\n  //       if (json.myBingos && json.myBingos.length > 0) {\n  //         this.unreadBingos = json.myBingos;\n  //         this.showUnreadPopups();\n  //       }\n  //     })\n  //     .catch(e => console.error(e));\n  // };\n\n  // showUnreadPopups = () => {\n  //   if (this.unreadBingos && this.unreadBingos.length > 0) {\n  //     const unread = this.unreadBingos.shift();\n  //     const { email } = this.props.userinfo;\n  //     showBingoPopup(email, unread.bingoType, {\n  //       // confirmAction: () => {\n  //       //   this.showUnreadPopups();\n  //       // },\n  //       cancelAction: () => {\n  //         this.showUnreadPopups();\n  //       }\n  //     });\n  //   }\n  // };\n\n  componentWillUnmount() {\n    window.removeEventListener(\"focus\", this.handleWindowFocus);\n    window.removeEventListener(\"blur\", this.handleWindowBlur);\n    window.removeEventListener(\"message\", this.onMessage);\n  }\n\n  onMessage = e => {\n    // console.log(\"UserInfoContainer onMessage\", e);\n    if (e.origin === URL.WIZLIVE || e.origin === URL.WIZLIVE_WWW) {\n      if (e.data.type === \"ready\") {\n        if (this.liveIframe.current) {\n          this.liveIframe.current.contentWindow.postMessage(\n            { type: \"requestToken\" },\n            \"*\"\n          );\n        }\n      } else if (e.data.type === \"token\") {\n        if (e.data.data) {\n          localStorage.setItem(\"wizToken\", e.data.data);\n          this.handleLoginByToken();\n        } else {\n          this.setState({ wizliveURL: URL.WIZLIVE_WWW });\n        }\n      } else {\n        // console.log(\"UserInfoContainer unknown data\", e.data);\n      }\n    }\n  };\n\n  handleLoginByToken = async e => {\n    const token = localStorage.getItem(\"wizToken\");\n    // console.log(\"login by token\", token);\n    if (token) {\n      const params = { token };\n      try {\n        const response = await request.loginByToken(params);\n        const json = await response.json();\n        if (json.user) {\n          let user = json.user;\n          user.payment = json.payment;\n          localStorage.setItem(\"wizToken\", json.token);\n          this.props.updateUserInfo(user);\n          this.setState({ mounted: true });\n        } else {\n          // console.log(\"user not found\");\n          // localStorage.removeItem(\"wizToken\");\n          this.props.updateUserInfo();\n          this.setState({ mounted: true });\n        }\n      } catch (err) {\n        // console.log(\"request failed\");\n        // localStorage.removeItem(\"wizToken\");\n        this.props.updateUserInfo();\n        this.setState({ mounted: true });\n      }\n    } else {\n      // console.log(\"token not found\");\n      // localStorage.removeItem(\"wizToken\");\n      this.props.updateUserInfo();\n      this.setState({ mounted: true });\n    }\n\n    //for ocp\n    if (\n      this.props.match.path.split(\"/\")[1] === \"ocp2\" &&\n      this.props.match.params.step === \"1\"\n    ) {\n      OcpToken.addOcpUser(\n        this.props.userinfo.email,\n        this.props.match.params.grade,\n        this.props.match.params.type\n          ? this.props.match.params.type\n          : this.props.match.path.split(\"/\")[2]\n      );\n    }\n    OcpToken.updateOcpToken();\n  };\n\n  handleWindowBlur = e => {\n    this.windowFocused = false;\n  };\n\n  handleWindowFocus = e => {\n    const isNeedUpdate = this.windowFocused === false;\n    this.windowFocused = true;\n    const token = localStorage.getItem(\"wizToken\");\n    if (token) {\n      const json = this.parseJwt(token);\n      const tokenEmail = json.email;\n      if (tokenEmail !== this.props.userinfo.email) {\n        //window.location.reload();\n      } else {\n        if (isNeedUpdate) {\n          // this.checkUnreadBingoEvents();\n        }\n      }\n    }\n    if (!token && Object.keys(this.props.userinfo).length > 0) {\n      this.props.updateUserInfo();\n    }\n  };\n\n  parseJwt(token) {\n    var base64Url = token.split(\".\")[1];\n    var base64 = base64Url.replace(/-/g, \"+\").replace(/_/g, \"/\");\n    return JSON.parse(window.atob(base64));\n  }\n\n  handleLoginTokenFromQuery() {\n    const params = QueryString.parse(window.location.search);\n    const { loginToken } = params;\n    if (loginToken) {\n      localStorage.setItem(\"wizToken\", loginToken);\n      const replaceUrl = window.location.href.split(\"?\")[0];\n      window.history.replaceState({}, undefined, replaceUrl);\n    }\n  }\n\n  render() {\n    return (\n      <React.Fragment>\n        {this.state.mounted === true ? this.props.children : null}\n        {this.shouldLogin && (\n          <iframe\n            title=\"tokenIFrame\"\n            ref={this.liveIframe}\n            src={this.state.wizliveURL + \"/tokenIFrame\"}\n            style={{ display: \"none\" }}\n          />\n        )}\n      </React.Fragment>\n    );\n  }\n}\n\nexport default connect(\n  state => ({\n    userinfo: state.userinfo\n  }),\n  {\n    updateUserInfo: action.updateUserInfo\n  }\n)(withRouter(UserInfoContainer));\n"]},"metadata":{},"sourceType":"module"}