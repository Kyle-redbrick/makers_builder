{"ast":null,"code":"import _objectSpread from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread\";\nimport _objectWithoutProperties from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectWithoutProperties\";\nimport _regeneratorRuntime from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\nimport _classCallCheck from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";\nimport _possibleConstructorReturn from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/getPrototypeOf\";\nimport _inherits from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/inherits\";\nvar _jsxFileName = \"/Users/jimmy/Documents/Wizschool/wizlab_web2/src/Page/Builder/Component/MultiSocket/Container.js\";\nimport React, { Component } from \"react\";\nimport { connect } from \"react-redux\";\nimport AssetLibrary from \"../../utils/assetLibrary\";\nimport * as request from \"../../../../Common/Util/HTTPRequest\";\nimport * as projectActions from \"../../Store/Reducer/project\";\nimport * as tabActions from \"../../Store/Reducer/tabs\";\nimport * as interactionActions from \"../../Store/Reducer/interaction\";\nimport { socketUtil } from \"../Socket/Container\";\nimport './index.scss';\n\nvar Container =\n/*#__PURE__*/\nfunction (_Component) {\n  _inherits(Container, _Component);\n\n  function Container(props) {\n    var _this;\n\n    _classCallCheck(this, Container);\n\n    _this = _possibleConstructorReturn(this, _getPrototypeOf(Container).call(this, props));\n    _this.EVENT_CONNECT = \"connect\";\n    _this.EVENT_MULTI_STATE = \"multiState\";\n    _this.EVENT_JOIN = \"join\";\n    _this.EVENT_LEAVE = \"leave\";\n    _this.EVENT_HIGHLIGHT = \"highlight\";\n    _this.EVENT_JOIN_ROOM = \"joinRoom\";\n\n    _this.setupSocket = function () {\n      // const options = {}; //options reference : https://socket.io/docs/client-api/#new-Manager-url-options\n      _this.socket = socketUtil.socket;\n\n      _this.socket.emit(_this.EVENT_JOIN_ROOM, {\n        roomId: _this.props.roomId\n      }); // global room\n\n\n      _this.setSocketListener();\n    };\n\n    _this.setSocketListener = function () {\n      _this.socket.on(_this.EVENT_MULTI_STATE,\n      /*#__PURE__*/\n      function () {\n        var _ref = _asyncToGenerator(\n        /*#__PURE__*/\n        _regeneratorRuntime.mark(function _callee(data) {\n          return _regeneratorRuntime.wrap(function _callee$(_context) {\n            while (1) {\n              switch (_context.prev = _context.next) {\n                case 0:\n                  if (_this.props.currentUser) {\n                    _context.next = 2;\n                    break;\n                  }\n\n                  return _context.abrupt(\"return\");\n\n                case 2:\n                  if (_this.props.currentUser.email !== _this.props.email) {\n                    _this.setProject(data);\n                  } // if (\n                  //   this.props.currentUser.email !== this.props.email &&\n                  //   !this.props.isTutor &&\n                  //   data.from === \"owner\"\n                  //   ) {\n                  //   this.setProject(data);\n                  //   console.log(1111, \"from owner to others in room on data \", data)\n                  // }\n                  // else if (\n                  //   this.props.currentUser.email === this.props.email &&\n                  //   !this.props.isTutor &&\n                  //   data.from === \"tutor\"\n                  // ) {\n                  //   if (this.compareProjectState(data)) {\n                  //     this.setProject(data);\n                  //     setMyProject(data.state);\n                  //     console.log(1111, \"from tutor to owner on data\", data)\n                  //   }\n                  // }\n                  // else if (\n                  //   this.props.currentUser.email !== this.props.email &&\n                  //   this.props.isTutor &&\n                  //   data.from === \"owner\"\n                  // ) {\n                  //   if (this.compareProjectState(data)) {\n                  //     this.setProject(data);\n                  //     console.log(1111, \"from owner to tutor on data\", data)\n                  //   }\n                  // }\n\n\n                case 3:\n                case \"end\":\n                  return _context.stop();\n              }\n            }\n          }, _callee, this);\n        }));\n\n        return function (_x) {\n          return _ref.apply(this, arguments);\n        };\n      }()); //  튜터가 버튼 표시\n\n\n      _this.socket.on(_this.EVENT_HIGHLIGHT, function (data) {\n        // 타이머 리셋\n        if (_this.timer) {\n          clearTimeout(_this.timer);\n        }\n\n        _this.props.setBtnHighlight(data.highlightBtnId);\n\n        _this.timer = setTimeout(function () {\n          _this.props.setBtnHighlight();\n        }, 200);\n      });\n    };\n\n    _this.setProject =\n    /*#__PURE__*/\n    function () {\n      var _ref2 = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee2(data) {\n        var project, assets;\n        return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                project = {};\n                project.state = JSON.parse(data.state);\n                _context2.next = 4;\n                return AssetLibrary.loadAssetsForGame(project.state.scene);\n\n              case 4:\n                assets = _context2.sent;\n                AssetLibrary.setAll(assets);\n\n                _this.props.setProject(project);\n\n              case 7:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2, this);\n      }));\n\n      return function (_x2) {\n        return _ref2.apply(this, arguments);\n      };\n    }();\n\n    _this.getDevelopingProject =\n    /*#__PURE__*/\n    function () {\n      var _ref3 = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee3(pId) {\n        var param, preUser, data, project, assets;\n        return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                _context3.prev = 0;\n\n                _this.setState({\n                  isLoading: true\n                });\n\n                param = {\n                  pId: pId\n                };\n                preUser = _this.props.currentUser.email;\n                _context3.next = 6;\n                return request.getDevelopingProject(param).then(function (res) {\n                  return res.json();\n                });\n\n              case 6:\n                data = _context3.sent;\n\n                if (!(data.state && _this.props.currentUser.email === preUser)) {\n                  _context3.next = 18;\n                  break;\n                }\n\n                project = {};\n                project.state = JSON.parse(data.state);\n                _context3.next = 12;\n                return AssetLibrary.loadAssetsForGame(project.state.scene);\n\n              case 12:\n                assets = _context3.sent;\n                AssetLibrary.setAll(assets);\n\n                _this.props.setProject(project);\n\n                return _context3.abrupt(\"return\", true);\n\n              case 18:\n                return _context3.abrupt(\"return\", false);\n\n              case 19:\n                _context3.next = 24;\n                break;\n\n              case 21:\n                _context3.prev = 21;\n                _context3.t0 = _context3[\"catch\"](0);\n                console.error(_context3.t0);\n\n              case 24:\n                _context3.prev = 24;\n\n                _this.setState({\n                  isLoading: false\n                });\n\n                return _context3.finish(24);\n\n              case 27:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3, this, [[0, 21, 24, 27]]);\n      }));\n\n      return function (_x3) {\n        return _ref3.apply(this, arguments);\n      };\n    }();\n\n    _this.getMyProject =\n    /*#__PURE__*/\n    _asyncToGenerator(\n    /*#__PURE__*/\n    _regeneratorRuntime.mark(function _callee4() {\n      var state, project, assets;\n      return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n        while (1) {\n          switch (_context4.prev = _context4.next) {\n            case 0:\n              _context4.prev = 0;\n              state = localStorage.getItem(\"wizProject\");\n              project = {};\n              project.state = JSON.parse(state);\n              _context4.next = 6;\n              return AssetLibrary.loadAssetsForGame(project.state.scene);\n\n            case 6:\n              assets = _context4.sent;\n              AssetLibrary.setAll(assets);\n\n              _this.props.setProject(project);\n\n              _context4.next = 14;\n              break;\n\n            case 11:\n              _context4.prev = 11;\n              _context4.t0 = _context4[\"catch\"](0);\n              console.error(_context4.t0);\n\n            case 14:\n            case \"end\":\n              return _context4.stop();\n          }\n        }\n      }, _callee4, this, [[0, 11]]);\n    }));\n    _this.currentUser = null;\n    _this.timer = null;\n    _this.state = {\n      isLoading: false\n    };\n    return _this;\n  }\n\n  _createClass(Container, [{\n    key: \"componentDidMount\",\n    value: function componentDidMount() {\n      this.setupSocket();\n    }\n  }, {\n    key: \"componentDidUpdate\",\n    value: function componentDidUpdate(prevProps) {\n      if (!this.props.currentUser) return; // current user 상태가 변경 됐을 때\n\n      if (prevProps.currentUser.email !== this.props.currentUser.email) {\n        // current user가 나인 경우 (other -> me)\n        if (this.props.currentUser.email === this.props.email) {\n          this.socket.emit(this.EVENT_LEAVE, {\n            email: prevProps.currentUser.email\n          });\n          this.getMyProject();\n          this.socket.emit(this.EVENT_JOIN, {\n            email: this.props.currentUser.email\n          }); // current user가 내가 아닌 경우\n        } else if (this.props.currentUser.email !== this.props.email) {\n          // 기존 current user가 내가 아닌 경우 (other -> other)\n          if (prevProps.currentUser.email !== this.props.email) {\n            this.socket.emit(this.EVENT_LEAVE, {\n              email: prevProps.currentUser.email\n            });\n\n            if (this.getDevelopingProject(this.props.currentUser.pId)) {\n              this.socket.emit(this.EVENT_JOIN, {\n                email: this.props.currentUser.email\n              });\n            } // 기존 current user가 나인 경우 (me -> other)\n\n          } else if (prevProps.currentUser.email === this.props.email) {\n            if (this.getDevelopingProject(this.props.currentUser.pId)) {\n              this.socket.emit(this.EVENT_JOIN, {\n                email: this.props.currentUser.email\n              });\n            }\n          }\n        }\n      }\n\n      if (prevProps.highlightBtnId !== this.props.highlightBtnId) {\n        if (this.props.isTutor) {\n          !prevProps.highlightBtnId && this.socket.emit(this.EVENT_HIGHLIGHT, {\n            highlightBtnId: this.props.highlightBtnId,\n            roomId: this.props.roomId\n          });\n        }\n      }\n    }\n  }, {\n    key: \"componentWillUnmount\",\n    value: function componentWillUnmount() {\n      this.socket.disconnect();\n    }\n  }, {\n    key: \"render\",\n    value: function render() {\n      if (this.state.isLoading) {\n        return React.createElement(\"div\", {\n          className: \"multi-socket\",\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 196\n          },\n          __self: this\n        }, React.createElement(\"div\", {\n          className: \"multi-socket__progress\",\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 197\n          },\n          __self: this\n        }));\n      }\n\n      return React.createElement(\"div\", {\n        style: {\n          display: \"none\"\n        },\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 201\n        },\n        __self: this\n      });\n    }\n  }]);\n\n  return Container;\n}(Component);\n\nexport default connect(function (state) {\n  var _state$scene = state.scene,\n      history = _state$scene.history,\n      historyIndex = _state$scene.historyIndex,\n      _scene = _objectWithoutProperties(_state$scene, [\"history\", \"historyIndex\"]);\n\n  return {\n    email: state.userinfo.email,\n    selectedSceneId: state.interaction.selected.scene,\n    selectedObject: state.interaction.selected.objects[state.interaction.selected.scene],\n    pId: state.project.pId,\n    scene: _scene,\n    interaction: _objectSpread({}, state.interaction, {\n      jukebox: {\n        isPlaying: false\n      },\n      addSoundsTimeStamp: undefined\n    }),\n    preview: state.preview,\n    currentUser: state.tabs.currentUser,\n    highlightBtnId: state.interaction.highlightBtnId\n  };\n}, {\n  setStudents: tabActions.setStudents,\n  setTutor: tabActions.setTutor,\n  setProject: projectActions.setProject,\n  setBtnHighlight: interactionActions.setBtnHighlight\n})(Container);\nexport function setMyProject(props) {\n  try {\n    var scene = props.scene,\n        interaction = props.interaction,\n        preview = props.preview;\n    var state = JSON.stringify({\n      scene: scene,\n      interaction: _objectSpread({}, interaction, {\n        isPublished: undefined\n      }),\n      preview: _objectSpread({}, preview, {\n        isPlaying: false\n      })\n    });\n    localStorage.setItem(\"wizProject\", state);\n  } catch (err) {\n    console.err(err);\n  }\n}\n;","map":{"version":3,"sources":["/Users/jimmy/Documents/Wizschool/wizlab_web2/src/Page/Builder/Component/MultiSocket/Container.js"],"names":["React","Component","connect","AssetLibrary","request","projectActions","tabActions","interactionActions","socketUtil","Container","props","EVENT_CONNECT","EVENT_MULTI_STATE","EVENT_JOIN","EVENT_LEAVE","EVENT_HIGHLIGHT","EVENT_JOIN_ROOM","setupSocket","socket","emit","roomId","setSocketListener","on","data","currentUser","email","setProject","timer","clearTimeout","setBtnHighlight","highlightBtnId","setTimeout","project","state","JSON","parse","loadAssetsForGame","scene","assets","setAll","getDevelopingProject","pId","setState","isLoading","param","preUser","then","res","json","console","error","getMyProject","localStorage","getItem","prevProps","isTutor","disconnect","display","history","historyIndex","_scene","userinfo","selectedSceneId","interaction","selected","selectedObject","objects","jukebox","isPlaying","addSoundsTimeStamp","undefined","preview","tabs","setStudents","setTutor","setMyProject","stringify","isPublished","setItem","err"],"mappings":"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","sourcesContent":["import React, { Component } from \"react\";\nimport { connect } from \"react-redux\";\nimport AssetLibrary from \"../../utils/assetLibrary\";\nimport * as request from \"../../../../Common/Util/HTTPRequest\";\nimport * as projectActions from \"../../Store/Reducer/project\";\nimport * as tabActions from \"../../Store/Reducer/tabs\";\nimport * as interactionActions from \"../../Store/Reducer/interaction\";\nimport { socketUtil } from \"../Socket/Container\";\nimport './index.scss';\n\nclass Container extends Component {\n  EVENT_CONNECT = \"connect\";\n  EVENT_MULTI_STATE = \"multiState\";\n  EVENT_JOIN = \"join\";\n  EVENT_LEAVE = \"leave\";\n  EVENT_HIGHLIGHT = \"highlight\";\n  EVENT_JOIN_ROOM = \"joinRoom\";\n\n  constructor(props) {\n    super(props);\n    this.currentUser = null;\n    this.timer = null;\n\n    this.state = {\n      isLoading: false\n    }\n  }\n\n  componentDidMount() {\n    this.setupSocket();\n  }\n\n  componentDidUpdate(prevProps) {\n    if (!this.props.currentUser) return;\n    // current user 상태가 변경 됐을 때\n    if (prevProps.currentUser.email !== this.props.currentUser.email) {\n      // current user가 나인 경우 (other -> me)\n      if (this.props.currentUser.email === this.props.email) {\n        this.socket.emit(this.EVENT_LEAVE, {\n          email: prevProps.currentUser.email\n        });\n        this.getMyProject();\n        this.socket.emit(this.EVENT_JOIN, {\n          email: this.props.currentUser.email\n        });\n        // current user가 내가 아닌 경우\n      } else if (this.props.currentUser.email !== this.props.email) {\n        // 기존 current user가 내가 아닌 경우 (other -> other)\n        if (prevProps.currentUser.email !== this.props.email) {\n          this.socket.emit(this.EVENT_LEAVE, {\n            email: prevProps.currentUser.email\n          });\n\n          if (this.getDevelopingProject(this.props.currentUser.pId)) {\n            this.socket.emit(this.EVENT_JOIN, {\n              email: this.props.currentUser.email\n            });\n          }\n          // 기존 current user가 나인 경우 (me -> other)\n        } else if (prevProps.currentUser.email === this.props.email) {\n          if (this.getDevelopingProject(this.props.currentUser.pId)) {\n            this.socket.emit(this.EVENT_JOIN, {\n              email: this.props.currentUser.email\n            });\n          }\n        }\n      }\n    }\n    if (prevProps.highlightBtnId !== this.props.highlightBtnId) {\n      if (this.props.isTutor) {\n        !prevProps.highlightBtnId &&\n          this.socket.emit(this.EVENT_HIGHLIGHT, {\n            highlightBtnId: this.props.highlightBtnId,\n            roomId: this.props.roomId\n          });\n      }\n    }\n  }\n\n  componentWillUnmount() {\n    this.socket.disconnect();\n  }\n\n  setupSocket = () => {\n    // const options = {}; //options reference : https://socket.io/docs/client-api/#new-Manager-url-options\n    this.socket = socketUtil.socket;\n    this.socket.emit(this.EVENT_JOIN_ROOM, { roomId: this.props.roomId }); // global room\n\n    this.setSocketListener();\n  };\n\n  setSocketListener = () => {\n    this.socket.on(this.EVENT_MULTI_STATE, async data => {\n      if (!this.props.currentUser) return;\n\n      if (this.props.currentUser.email !== this.props.email) {\n        this.setProject(data);\n      }\n      // if (\n      //   this.props.currentUser.email !== this.props.email &&\n      //   !this.props.isTutor &&\n      //   data.from === \"owner\"\n      //   ) {\n      //   this.setProject(data);\n      //   console.log(1111, \"from owner to others in room on data \", data)\n      // }\n      // else if (\n      //   this.props.currentUser.email === this.props.email &&\n      //   !this.props.isTutor &&\n      //   data.from === \"tutor\"\n      // ) {\n      //   if (this.compareProjectState(data)) {\n      //     this.setProject(data);\n      //     setMyProject(data.state);\n      //     console.log(1111, \"from tutor to owner on data\", data)\n      //   }\n      // }\n      // else if (\n      //   this.props.currentUser.email !== this.props.email &&\n      //   this.props.isTutor &&\n      //   data.from === \"owner\"\n      // ) {\n      //   if (this.compareProjectState(data)) {\n      //     this.setProject(data);\n      //     console.log(1111, \"from owner to tutor on data\", data)\n      //   }\n      // }\n    });\n    //  튜터가 버튼 표시\n    this.socket.on(this.EVENT_HIGHLIGHT, data => {\n      // 타이머 리셋\n      if (this.timer) {\n        clearTimeout(this.timer);\n      }\n      this.props.setBtnHighlight(data.highlightBtnId);\n      \n      this.timer = setTimeout(() => {\n        this.props.setBtnHighlight();\n      }, 200);\n    });\n  };\n\n  setProject = async data => {\n    const project = {};\n    project.state = JSON.parse(data.state);\n    const assets = await AssetLibrary.loadAssetsForGame(project.state.scene);\n    AssetLibrary.setAll(assets);\n    this.props.setProject(project);\n  };\n\n  getDevelopingProject = async pId => {\n    try {\n      this.setState({ isLoading: true })\n      const param = { pId };\n\n      const preUser = this.props.currentUser.email;\n      const data = await request\n        .getDevelopingProject(param)\n        .then(res => res.json());\n\n      if (data.state && this.props.currentUser.email === preUser) {\n        const project = {};\n        project.state = JSON.parse(data.state);\n        const assets = await AssetLibrary.loadAssetsForGame(project.state.scene);\n        AssetLibrary.setAll(assets);\n        this.props.setProject(project);\n\n        return true;\n      } else {\n        return false;\n      }\n    } catch (err) {\n      console.error(err);\n    } finally {\n      this.setState({ isLoading: false })\n    }\n  };\n\n  getMyProject = async () => {\n    try {\n      const state = localStorage.getItem(\"wizProject\");\n\n      const project = {};\n      project.state = JSON.parse(state);\n      const assets = await AssetLibrary.loadAssetsForGame(project.state.scene);\n      AssetLibrary.setAll(assets);\n      this.props.setProject(project);\n    } catch (err) {\n      console.error(err);\n    }\n  };\n\n  render() {\n    if (this.state.isLoading) {\n      return (\n        <div className=\"multi-socket\">\n          <div className=\"multi-socket__progress\"></div>\n        </div>\n      )\n    }\n    return <div style={{ display: \"none\" }} />;\n  }\n}\n\nexport default connect(\n  state => {\n    const { history, historyIndex, ..._scene } = state.scene;\n\n    return {\n      email: state.userinfo.email,\n      selectedSceneId: state.interaction.selected.scene,\n      selectedObject:\n        state.interaction.selected.objects[state.interaction.selected.scene],\n      pId: state.project.pId,\n      scene: _scene,\n      interaction: {\n        ...state.interaction,\n        jukebox: {\n          isPlaying: false\n        },\n        addSoundsTimeStamp: undefined\n      },\n      preview: state.preview,\n      currentUser: state.tabs.currentUser,\n      highlightBtnId: state.interaction.highlightBtnId\n    };\n  },\n  {\n    setStudents: tabActions.setStudents,\n    setTutor: tabActions.setTutor,\n    setProject: projectActions.setProject,\n    setBtnHighlight: interactionActions.setBtnHighlight\n  }\n)(Container);\n\nexport function setMyProject(props) {\n  try {\n    const { scene, interaction, preview } = props;\n\n    const state = JSON.stringify({\n      scene,\n      interaction: { ...interaction, isPublished: undefined },\n      preview: { ...preview, isPlaying: false }\n    });\n    localStorage.setItem(\"wizProject\", state);\n  } catch (err) {\n    console.err(err);\n  }\n};\n"]},"metadata":{},"sourceType":"module"}