{"ast":null,"code":"import _objectSpread from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/react-scripts/node_modules/@babel/runtime/helpers/esm/objectSpread\";\nimport _classCallCheck from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/react-scripts/node_modules/@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/react-scripts/node_modules/@babel/runtime/helpers/esm/createClass\";\nimport _possibleConstructorReturn from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/react-scripts/node_modules/@babel/runtime/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/react-scripts/node_modules/@babel/runtime/helpers/esm/getPrototypeOf\";\nimport _inherits from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/react-scripts/node_modules/@babel/runtime/helpers/esm/inherits\";\nvar _jsxFileName = \"/Users/jimmy/Documents/Wizschool/wizlab_web2/src/Page/Builder/Component/DreamBuilder/Container.js\";\nimport React, { Component } from \"react\";\nimport { withRouter } from \"react-router-dom\";\nimport { connect } from \"react-redux\";\nimport QueryString from \"query-string\";\nimport generatePID from \"../../../../Common/Util/PIDGenerator\";\nimport { showPopUp } from \"../../../../Common/Component/PopUp\";\nimport * as request from \"../../../../Common/Util/HTTPRequest\";\nimport * as userInfoActions from \"../../../../Common/Store/Reducer/UserInfo\";\nimport * as projectActions from \"../../Store/Reducer/project\";\nimport * as previewActions from \"../../Store/Reducer/preview\";\nimport * as dreamActions from \"../../Store/Reducer/dream\";\nimport AssetLibrary from \"../../utils/assetLibrary\";\nimport MissionClearPopUp from \"./PopUp/MissionClear\";\nimport ProjectClearPopUp from \"./PopUp/ProjectClear\";\nimport CreatorChallengePopUp from \"./PopUp/CreatorChallenge\";\nimport CertificateInput from \"./PopUp/CertificateInput\";\nimport CertificatePrint from \"../../../../Common/Component/LearnCertification\";\nimport View from \"./View\";\n\nvar Container =\n/*#__PURE__*/\nfunction (_Component) {\n  _inherits(Container, _Component);\n\n  function Container(props) {\n    var _this;\n\n    _classCallCheck(this, Container);\n\n    _this = _possibleConstructorReturn(this, _getPrototypeOf(Container).call(this, props));\n\n    _this.linkToDeveloping = function (developing) {\n      _this.props.history.replace(\"/builder/\".concat(developing.pId));\n\n      _this.props.history.go(0);\n    };\n\n    _this.forceSlideRerender = function () {\n      _this.setState({\n        shouldSlideRerender: true\n      }, function () {\n        _this.setState({\n          shouldSlideRerender: false\n        });\n      });\n    };\n\n    _this.didShowTutorialPopup = function () {\n      var didShowTutorialPopup = localStorage.getItem(\"didShowTutorial_\".concat(_this.props.editorMode));\n      if (didShowTutorialPopup) _this.setState({\n        isTutorialShow: false\n      });else _this.setState({\n        isTutorialShow: true\n      });\n    };\n\n    _this.hiddenTutorial = function () {\n      _this.setState({\n        isTutorialShow: false\n      });\n    };\n\n    _this.state = {\n      shouldSlideRerender: false,\n      isTutorialShow: false\n    };\n    return _this;\n  }\n\n  _createClass(Container, [{\n    key: \"componentDidMount\",\n    value: function componentDidMount() {\n      this.load();\n    }\n  }, {\n    key: \"load\",\n    value: function load() {\n      var _this2 = this;\n\n      request.getLearnUserProject({\n        userId: this.props.user.id,\n        projectId: this.props.match.params.projectId,\n        includeTemplate: true\n      }).then(function (res) {\n        return res.json();\n      }).then(function (userProject) {\n        try {\n          userProject.project.template = JSON.parse(userProject.project.template);\n        } catch (err) {\n          window.alert(\"wrong template\");\n          return;\n        }\n\n        _this2.props.setMyDreamProject(userProject);\n      });\n    }\n  }, {\n    key: \"componentDidUpdate\",\n    value: function componentDidUpdate(prevProps, prevState) {\n      if (this.props.myProject) {\n        if (!prevProps.myProject || prevProps.myProject.id !== this.props.myProject.id) {\n          this.didSetMyProject();\n        }\n      }\n\n      if (prevProps.currentMission !== this.props.currentMission) {\n        this.didSetCurrentMission();\n      }\n\n      if (prevProps.isConditionsClear !== this.props.isConditionsClear) {\n        if (this.props.currentMission && this.props.isConditionsClear) {\n          this.didClearConditions();\n        }\n      }\n\n      if (prevProps.editorMode !== this.props.editorMode) {\n        this.didShowTutorialPopup();\n      }\n    }\n  }, {\n    key: \"didSetMyProject\",\n    value: function didSetMyProject() {\n      var myProject = this.props.myProject;\n      var missions = (myProject.project.template.missions || []).map(function (mission, index) {\n        return _objectSpread({}, mission, {\n          isCompleted: index < myProject.currentMission\n        });\n      });\n      var currentMissionIndex = myProject.currentMission;\n\n      if (this.designatedMissionIndex >= 0 && this.designatedMissionIndex <= myProject.currentMission) {\n        currentMissionIndex = this.designatedMissionIndex;\n      } else if (this.props.isReplaying) {\n        currentMissionIndex = 0;\n      }\n\n      if (currentMissionIndex > missions.length - 1) {\n        currentMissionIndex = missions.length - 1;\n      }\n\n      this.props.setDreamMissions(missions);\n      this.props.setCurrentDreamMissionIndex(currentMissionIndex);\n    }\n  }, {\n    key: \"didSetCurrentMission\",\n    value: function didSetCurrentMission() {\n      var _this3 = this;\n\n      if (!this.props.currentMission) return;\n\n      if (this.missionSetTimer) {\n        clearTimeout(this.missionSetTimer);\n      } // TODO: Refer to the following issue.\n      // Issue Link: https://www.notion.so/wizschool/b77303a59acc4be7886ec81875607bf6\n\n\n      this.missionSetTimer = setTimeout(function () {\n        try {\n          var state = JSON.parse(_this3.props.currentMission.state);\n          AssetLibrary.loadAssetsFromScene(state.scene, function () {\n            _this3.props.setProject({\n              state: state\n            });\n\n            _this3.forceSlideRerender();\n          });\n        } catch (err) {\n          window.alert(\"wrong mission state\");\n        }\n      }, 200);\n    }\n  }, {\n    key: \"didClearConditions\",\n    value: function didClearConditions() {\n      if (!this.props.currentMission.isCompleted || this.props.isReplaying) {\n        this.props.completeCurrentDreamMission();\n\n        if (this.props.currentMissionIndex < this.props.missions.length - 1) {\n          this.didClearMission();\n        } else {\n          this.didClearProject();\n        }\n      }\n    }\n  }, {\n    key: \"didClearMission\",\n    value: function didClearMission() {\n      if (!this.props.isReplaying) {\n        this.saveMissionClear();\n      }\n\n      if (this.props.currentMission.conditions && this.props.currentMission.conditions.length > 0) {\n        setTimeout(this.alertMissionClear.bind(this), 2000);\n      }\n    }\n  }, {\n    key: \"didClearProject\",\n    value: function didClearProject() {\n      if (!this.props.isReplaying) {\n        this.saveProjectClear();\n        this.createDeveloping();\n      }\n\n      setTimeout(this.alertProjectClear.bind(this), 1000);\n    }\n  }, {\n    key: \"saveMissionClear\",\n    value: function saveMissionClear() {\n      this.save({\n        currentMission: this.props.currentMissionIndex + 1\n      });\n    }\n  }, {\n    key: \"saveProjectClear\",\n    value: function saveProjectClear() {\n      this.save({\n        currentMission: this.props.missions.length - 1,\n        isComplete: true\n      });\n    }\n  }, {\n    key: \"save\",\n    value: function save(values) {\n      request.updateLearnUserProject(_objectSpread({\n        userId: this.props.user.id,\n        projectId: this.props.match.params.projectId\n      }, values)).catch(console.err);\n    }\n  }, {\n    key: \"alertMissionClear\",\n    value: function alertMissionClear() {\n      var _this4 = this;\n\n      showPopUp(React.createElement(MissionClearPopUp, {\n        onClickConfirm: function onClickConfirm() {\n          _this4.props.setIsPlaying(false);\n\n          _this4.props.setCurrentDreamMissionIndex(_this4.props.currentMissionIndex + 1);\n        },\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 169\n        },\n        __self: this\n      }), {\n        dismissButton: false\n      });\n    }\n  }, {\n    key: \"alertProjectClear\",\n    value: function alertProjectClear() {\n      showPopUp(React.createElement(ProjectClearPopUp, {\n        user: this.props.user,\n        myProject: this.props.myProject,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 179\n        },\n        __self: this\n      }), {\n        dismissButton: false\n      });\n    }\n  }, {\n    key: \"createDeveloping\",\n    value: function createDeveloping(callback) {\n      var _this$props$myProject = this.props.myProject,\n          id = _this$props$myProject.id,\n          project = _this$props$myProject.project;\n      var params = {\n        pId: generatePID(this.props.email),\n        email: this.props.email,\n        name: project.title,\n        type: project.lang,\n        icon: project.smallImage,\n        useCustomIcon: true,\n        state: JSON.stringify(this.getManipulatedProjectState()),\n        myDreamProjectId: id\n      };\n      request.postDevelopingProject(params).then(function (res) {\n        return res.json();\n      }).then(function (developing) {\n        if (callback) {\n          callback(developing);\n        }\n      });\n    }\n  }, {\n    key: \"getManipulatedProjectState\",\n    value: function getManipulatedProjectState() {\n      var state = JSON.parse(JSON.stringify(this.props.projectState));\n      state.preview.isPlaying = false;\n\n      for (var sceneId in state.scene.scenes) {\n        var scene = state.scene.scenes[sceneId];\n        scene.isHiddenLockSprites = false;\n\n        for (var spriteId in scene.sprites) {\n          var sprite = scene.sprites[spriteId];\n          sprite.locked = false;\n        }\n      }\n\n      return state;\n    }\n  }, {\n    key: \"render\",\n    value: function render() {\n      return React.createElement(View, Object.assign({}, this.props, {\n        shouldSlideRerender: this.state.shouldSlideRerender,\n        isTutorialShow: this.state.isTutorialShow,\n        hiddenTutorial: this.hiddenTutorial,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 241\n        },\n        __self: this\n      }));\n    }\n  }, {\n    key: \"designatedMissionIndex\",\n    get: function get() {\n      var _QueryString$parse = QueryString.parse(this.props.location.search),\n          currentMission = _QueryString$parse.currentMission;\n\n      var index = parseInt(currentMission);\n      return isNaN(index) ? -1 : index;\n    }\n  }]);\n\n  return Container;\n}(Component);\n\nexport default connect(function (state) {\n  return {\n    editorMode: state.scene.editorMode,\n    user: state.userinfo,\n    userId: state.userinfo.id,\n    email: state.userinfo.email,\n    myProject: state.dream.myProject,\n    isReplaying: state.dream.isReplaying,\n    missions: state.dream.missions,\n    currentMission: state.dream.currentMission,\n    currentMissionIndex: state.dream.currentMissionIndex,\n    isConditionsClear: state.dream.isConditionsClear,\n    isCodeConditionsClear: state.dream.isCodeConditionsClear,\n    projectState: {\n      scene: state.scene,\n      interaction: state.interaction,\n      preview: state.preview\n    }\n  };\n}, {\n  updateUser: userInfoActions.updateUserInfo,\n  setProject: projectActions.setProject,\n  setIsPlaying: previewActions.setIsPlaying,\n  setMyDreamProject: dreamActions.setMyDreamProject,\n  setDreamMissions: dreamActions.setDreamMissions,\n  setCurrentDreamMissionIndex: dreamActions.setCurrentDreamMissionIndex,\n  completeCurrentDreamMission: dreamActions.completeCurrentDreamMission\n})(withRouter(Container));","map":{"version":3,"sources":["/Users/jimmy/Documents/Wizschool/wizlab_web2/src/Page/Builder/Component/DreamBuilder/Container.js"],"names":["React","Component","withRouter","connect","QueryString","generatePID","showPopUp","request","userInfoActions","projectActions","previewActions","dreamActions","AssetLibrary","MissionClearPopUp","ProjectClearPopUp","CreatorChallengePopUp","CertificateInput","CertificatePrint","View","Container","props","linkToDeveloping","developing","history","replace","pId","go","forceSlideRerender","setState","shouldSlideRerender","didShowTutorialPopup","localStorage","getItem","editorMode","isTutorialShow","hiddenTutorial","state","load","getLearnUserProject","userId","user","id","projectId","match","params","includeTemplate","then","res","json","userProject","project","template","JSON","parse","err","window","alert","setMyDreamProject","prevProps","prevState","myProject","didSetMyProject","currentMission","didSetCurrentMission","isConditionsClear","didClearConditions","missions","map","mission","index","isCompleted","currentMissionIndex","designatedMissionIndex","isReplaying","length","setDreamMissions","setCurrentDreamMissionIndex","missionSetTimer","clearTimeout","setTimeout","loadAssetsFromScene","scene","setProject","completeCurrentDreamMission","didClearMission","didClearProject","saveMissionClear","conditions","alertMissionClear","bind","saveProjectClear","createDeveloping","alertProjectClear","save","isComplete","values","updateLearnUserProject","catch","console","setIsPlaying","dismissButton","callback","email","name","title","type","lang","icon","smallImage","useCustomIcon","stringify","getManipulatedProjectState","myDreamProjectId","postDevelopingProject","projectState","preview","isPlaying","sceneId","scenes","isHiddenLockSprites","spriteId","sprites","sprite","locked","location","search","parseInt","isNaN","userinfo","dream","isCodeConditionsClear","interaction","updateUser","updateUserInfo"],"mappings":"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","sourcesContent":["import React, { Component } from \"react\";\nimport { withRouter } from \"react-router-dom\";\nimport { connect } from \"react-redux\";\nimport QueryString from \"query-string\";\nimport generatePID from \"../../../../Common/Util/PIDGenerator\"\nimport { showPopUp } from \"../../../../Common/Component/PopUp\"\nimport * as request from \"../../../../Common/Util/HTTPRequest\";\nimport * as userInfoActions from \"../../../../Common/Store/Reducer/UserInfo\";\nimport * as projectActions from \"../../Store/Reducer/project\";\nimport * as previewActions from \"../../Store/Reducer/preview\";\nimport * as dreamActions from \"../../Store/Reducer/dream\"\nimport AssetLibrary from \"../../utils/assetLibrary\";\nimport MissionClearPopUp from \"./PopUp/MissionClear\";\nimport ProjectClearPopUp from \"./PopUp/ProjectClear\";\nimport CreatorChallengePopUp from \"./PopUp/CreatorChallenge\";\nimport CertificateInput from \"./PopUp/CertificateInput\";\nimport CertificatePrint from \"../../../../Common/Component/LearnCertification\";\nimport View from \"./View\";\n\nclass Container extends Component {\n  constructor(props) {\n    super(props);\n    this.state = { \n      shouldSlideRerender: false, \n      isTutorialShow: false \n    };\n  }\n  componentDidMount() {\n    this.load();\n  }\n  load() {\n    request\n      .getLearnUserProject({\n        userId: this.props.user.id,\n        projectId: this.props.match.params.projectId,\n        includeTemplate: true\n      })\n      .then(res => res.json())\n      .then(userProject => {\n        try {\n          userProject.project.template = JSON.parse(userProject.project.template)\n        } catch(err) {\n          window.alert(\"wrong template\");\n          return;\n        }\n        this.props.setMyDreamProject(userProject);\n      })\n  }\n\n  componentDidUpdate(prevProps, prevState) {\n    if(this.props.myProject) {\n      if(!prevProps.myProject || prevProps.myProject.id !== this.props.myProject.id) {\n        this.didSetMyProject();\n      }\n    }\n    if(prevProps.currentMission !== this.props.currentMission) {\n      this.didSetCurrentMission();\n    }\n    if(prevProps.isConditionsClear !== this.props.isConditionsClear) {\n      if(this.props.currentMission && this.props.isConditionsClear) {\n        this.didClearConditions();\n      }\n    }\n    if(prevProps.editorMode !== this.props.editorMode) {\n      this.didShowTutorialPopup();\n    }\n  }\n  didSetMyProject() {\n    const { myProject } = this.props;\n\n    const missions = \n      (myProject.project.template.missions || [])\n      .map((mission, index) => ({\n        ...mission, \n        isCompleted: index < myProject.currentMission\n      }))\n\n    let currentMissionIndex = myProject.currentMission;\n    if(\n      this.designatedMissionIndex >= 0\n      && this.designatedMissionIndex <= myProject.currentMission\n    ) {\n      currentMissionIndex = this.designatedMissionIndex;\n    } else if(this.props.isReplaying) {\n      currentMissionIndex = 0;\n    }\n\n    if(currentMissionIndex > missions.length - 1) {\n      currentMissionIndex = missions.length - 1\n    }\n    \n    this.props.setDreamMissions(missions);\n    this.props.setCurrentDreamMissionIndex(currentMissionIndex);\n  }\n  get designatedMissionIndex() {\n    const { currentMission } = QueryString.parse(this.props.location.search);\n    const index = parseInt(currentMission);\n    return isNaN(index) ? -1 : index;\n  }\n  didSetCurrentMission() {\n    if(!this.props.currentMission) return;\n\n    if(this.missionSetTimer) {\n      clearTimeout(this.missionSetTimer);\n    }\n  \n    // TODO: Refer to the following issue.\n    // Issue Link: https://www.notion.so/wizschool/b77303a59acc4be7886ec81875607bf6\n    this.missionSetTimer = setTimeout(() => {\n      try {\n        const state = JSON.parse(this.props.currentMission.state);\n        AssetLibrary.loadAssetsFromScene(state.scene, () => {\n          this.props.setProject({ state });\n          this.forceSlideRerender();\n        });\n      } catch(err) {\n        window.alert(\"wrong mission state\");\n      }\n    }, 200);\n  }\n  didClearConditions() {\n    if(!this.props.currentMission.isCompleted || this.props.isReplaying) {\n      this.props.completeCurrentDreamMission();\n\n      if(this.props.currentMissionIndex < this.props.missions.length - 1) {\n        this.didClearMission();\n      } else {\n        this.didClearProject();\n      }\n    }\n  }\n  didClearMission() {\n    if(!this.props.isReplaying) {\n      this.saveMissionClear();\n    }\n    if(this.props.currentMission.conditions && this.props.currentMission.conditions.length > 0) {\n      setTimeout(this.alertMissionClear.bind(this), 2000);\n    }\n  }\n  didClearProject() {\n    if(!this.props.isReplaying) {\n      this.saveProjectClear();\n      this.createDeveloping();\n    }\n    setTimeout(this.alertProjectClear.bind(this), 1000);\n  }\n\n  saveMissionClear() {\n    this.save({ currentMission: this.props.currentMissionIndex + 1 });\n  }\n  saveProjectClear() {\n    this.save({ \n      currentMission: this.props.missions.length - 1,\n      isComplete: true\n    });\n  }\n  save(values) {\n    request\n      .updateLearnUserProject({\n        userId: this.props.user.id,\n        projectId: this.props.match.params.projectId,\n        ...values\n      })\n      .catch(console.err);\n  }\n\n  alertMissionClear() {\n    showPopUp(\n      <MissionClearPopUp\n        onClickConfirm={() => {\n          this.props.setIsPlaying(false);\n          this.props.setCurrentDreamMissionIndex(this.props.currentMissionIndex + 1);\n        }}\n      />, { dismissButton: false }\n    );\n  }\n  alertProjectClear() {\n    showPopUp(\n      <ProjectClearPopUp user={this.props.user} myProject={this.props.myProject}/>,\n      { dismissButton: false }\n    );\n  }\n\n  createDeveloping(callback) {\n    const { id, project } = this.props.myProject;\n    const params = {\n      pId: generatePID(this.props.email),\n      email: this.props.email,\n      name: project.title,\n      type: project.lang,\n      icon: project.smallImage,\n      useCustomIcon: true,\n      state: JSON.stringify(this.getManipulatedProjectState()),\n      myDreamProjectId: id\n    }\n    request\n      .postDevelopingProject(params)\n      .then(res => res.json())\n      .then(developing => {\n        if(callback) {\n          callback(developing);\n        }\n      })\n  }\n  getManipulatedProjectState() {\n    const state = JSON.parse(JSON.stringify(this.props.projectState));\n    state.preview.isPlaying = false;\n    for(let sceneId in state.scene.scenes) {\n      const scene = state.scene.scenes[sceneId];\n      scene.isHiddenLockSprites = false;\n      for(let spriteId in scene.sprites) {\n        const sprite = scene.sprites[spriteId];\n        sprite.locked = false;\n      }\n    }\n    return state;\n  }\n  linkToDeveloping = developing => {\n    this.props.history.replace(`/builder/${developing.pId}`);\n    this.props.history.go(0);\n  }\n\n  forceSlideRerender = () => {\n    this.setState({ shouldSlideRerender: true }, () => {\n      this.setState({ shouldSlideRerender: false });\n    });\n  }\n\n  didShowTutorialPopup = () => {\n    const didShowTutorialPopup = localStorage.getItem(`didShowTutorial_${this.props.editorMode}`);\n    if (didShowTutorialPopup) this.setState({ isTutorialShow: false });\n    else this.setState({ isTutorialShow: true });\n  }\n\n  hiddenTutorial = () => {\n    this.setState({ isTutorialShow: false });\n  }\n\n  render() {\n    return (\n      <View \n        {...this.props}\n        shouldSlideRerender={this.state.shouldSlideRerender}\n        isTutorialShow={this.state.isTutorialShow}\n        hiddenTutorial={this.hiddenTutorial}\n      />\n    );\n  }\n}\n\nexport default connect(\n  state => ({ \n    editorMode: state.scene.editorMode,\n    user: state.userinfo,\n    userId: state.userinfo.id,\n    email: state.userinfo.email,\n    myProject: state.dream.myProject,\n    isReplaying: state.dream.isReplaying,\n    missions: state.dream.missions,\n    currentMission: state.dream.currentMission,\n    currentMissionIndex: state.dream.currentMissionIndex,\n    isConditionsClear: state.dream.isConditionsClear,\n    isCodeConditionsClear: state.dream.isCodeConditionsClear,\n    projectState: {\n      scene: state.scene,\n      interaction: state.interaction,\n      preview: state.preview\n    }\n  }),\n  { \n    updateUser: userInfoActions.updateUserInfo,\n    setProject: projectActions.setProject,\n    setIsPlaying: previewActions.setIsPlaying,\n    setMyDreamProject: dreamActions.setMyDreamProject,\n    setDreamMissions: dreamActions.setDreamMissions,\n    setCurrentDreamMissionIndex: dreamActions.setCurrentDreamMissionIndex,\n    completeCurrentDreamMission: dreamActions.completeCurrentDreamMission\n  }\n)(withRouter(Container));\n"]},"metadata":{},"sourceType":"module"}