{"ast":null,"code":"import _regeneratorRuntime from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/react-scripts/node_modules/@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/react-scripts/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\nimport _classCallCheck from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/react-scripts/node_modules/@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/react-scripts/node_modules/@babel/runtime/helpers/esm/createClass\";\nimport _possibleConstructorReturn from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/react-scripts/node_modules/@babel/runtime/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/react-scripts/node_modules/@babel/runtime/helpers/esm/getPrototypeOf\";\nimport _inherits from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/react-scripts/node_modules/@babel/runtime/helpers/esm/inherits\";\nvar _jsxFileName = \"/Users/jimmy/Documents/Wizschool/wizlab_web2/src/Common/Component/UserInfo/index.js\";\nimport React from \"react\";\nimport QueryString from \"query-string\";\nimport { withRouter } from \"react-router-dom\";\nimport { URL } from \"../../Util/Constant.js\";\nimport { connect } from \"react-redux\";\nimport * as request from \"../../../Common/Util/HTTPRequest\";\nimport * as action from \"../../Store/Reducer/UserInfo\";\nimport * as OcpToken from \"../../Util/OcpToken\"; // import { showBingoPopup } from \"../../../Common/Component/PopUp/BingoPopup\";\n\nvar UserInfoContainer =\n/*#__PURE__*/\nfunction (_React$Component) {\n  _inherits(UserInfoContainer, _React$Component);\n\n  function UserInfoContainer(props) {\n    var _this;\n\n    _classCallCheck(this, UserInfoContainer);\n\n    _this = _possibleConstructorReturn(this, _getPrototypeOf(UserInfoContainer).call(this, props)); // console.log(\"UserInfoContainer constructor\", this.props);\n\n    _this.componentDidMount = function () {\n      window.addEventListener(\"focus\", _this.handleWindowFocus);\n      window.addEventListener(\"blur\", _this.handleWindowBlur);\n      window.addEventListener(\"message\", _this.onMessage, false);\n\n      _this.handleLoginTokenFromQuery();\n\n      if (!_this.shouldLogin) {\n        if (Object.keys(_this.props.userinfo).length === 0) {\n          _this.handleLoginByToken();\n        } else {\n          _this.setState({\n            mounted: true\n          });\n        }\n      }\n    };\n\n    _this.onMessage = function (e) {\n      // console.log(\"UserInfoContainer onMessage\", e);\n      if (e.origin === URL.WIZLIVE || e.origin === URL.WIZLIVE_WWW || e.origin.includes('redbrick')) {\n        console.log(3333, e.origin);\n\n        if (e.data.type === \"ready\") {\n          if (_this.liveIframe.current) {\n            _this.liveIframe.current.contentWindow.postMessage({\n              type: \"requestToken\"\n            }, \"*\");\n          }\n        } else if (e.data.type === \"token\") {\n          if (e.data.data) {\n            localStorage.setItem(\"wizToken\", e.data.data);\n            console.log(4444, e.data.data);\n\n            _this.handleLoginByToken();\n          } else {\n            _this.setState({\n              wizliveURL: URL.WIZLIVE_WWW\n            });\n          }\n        } else {// console.log(\"UserInfoContainer unknown data\", e.data);\n        }\n      }\n    };\n\n    _this.handleLoginByToken =\n    /*#__PURE__*/\n    function () {\n      var _ref = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee(e) {\n        var token, params, response, json, user;\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                token = localStorage.getItem(\"wizToken\"); // console.log(\"login by token\", token);\n\n                if (!token) {\n                  _context.next = 20;\n                  break;\n                }\n\n                params = {\n                  token: token\n                };\n                _context.prev = 3;\n                console.log(5555, 'login by token');\n                _context.next = 7;\n                return request.loginByToken(params);\n\n              case 7:\n                response = _context.sent;\n                _context.next = 10;\n                return response.json();\n\n              case 10:\n                json = _context.sent;\n\n                if (json.user) {\n                  user = json.user;\n                  user.payment = json.payment;\n                  localStorage.setItem(\"wizToken\", json.token);\n\n                  _this.props.updateUserInfo(user);\n\n                  _this.setState({\n                    mounted: true\n                  });\n                } else {\n                  // console.log(\"user not found\");\n                  // localStorage.removeItem(\"wizToken\");\n                  _this.props.updateUserInfo();\n\n                  _this.setState({\n                    mounted: true\n                  });\n                }\n\n                _context.next = 18;\n                break;\n\n              case 14:\n                _context.prev = 14;\n                _context.t0 = _context[\"catch\"](3);\n\n                // console.log(\"request failed\");\n                // localStorage.removeItem(\"wizToken\");\n                _this.props.updateUserInfo();\n\n                _this.setState({\n                  mounted: true\n                });\n\n              case 18:\n                _context.next = 22;\n                break;\n\n              case 20:\n                // console.log(\"token not found\");\n                // localStorage.removeItem(\"wizToken\");\n                _this.props.updateUserInfo();\n\n                _this.setState({\n                  mounted: true\n                });\n\n              case 22:\n                //for ocp\n                if (_this.props.match.path.split(\"/\")[1] === \"ocp2\" && _this.props.match.params.step === \"1\") {\n                  OcpToken.addOcpUser(_this.props.userinfo.email, _this.props.match.params.grade, _this.props.match.params.type ? _this.props.match.params.type : _this.props.match.path.split(\"/\")[2]);\n                }\n\n                OcpToken.updateOcpToken();\n\n              case 24:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this, [[3, 14]]);\n      }));\n\n      return function (_x) {\n        return _ref.apply(this, arguments);\n      };\n    }();\n\n    _this.handleWindowBlur = function (e) {\n      _this.windowFocused = false;\n    };\n\n    _this.handleWindowFocus = function (e) {\n      var isNeedUpdate = _this.windowFocused === false;\n      _this.windowFocused = true;\n      var token = localStorage.getItem(\"wizToken\");\n\n      if (token) {\n        var json = _this.parseJwt(token);\n\n        var tokenEmail = json.email;\n\n        if (tokenEmail !== _this.props.userinfo.email) {\n          window.location.reload();\n        } else {\n          if (isNeedUpdate) {// this.checkUnreadBingoEvents();\n          }\n        }\n      }\n\n      if (!token && Object.keys(_this.props.userinfo).length > 0) {\n        _this.props.updateUserInfo();\n      }\n    };\n\n    _this.state = {\n      mounted: false,\n      wizliveURL: URL.WIZLIVE\n    };\n    _this.showAlert = false;\n    _this.shouldLogin = _this.props.match.path === \"/wizlive/:pId\" || _this.props.match.path === \"/wizlive_1v4/:pId\" || _this.props.match.path === \"/builder_edit/:pId\" || _this.props.match.path === \"/builder_readonly/:pId\";\n    _this.liveToken = undefined;\n    _this.liveIframe = React.createRef();\n    _this.windowFocused = true;\n    return _this;\n  }\n\n  _createClass(UserInfoContainer, [{\n    key: \"shouldComponentUpdate\",\n    value: function shouldComponentUpdate(nextProps, nextState) {\n      this.showAlert = this.showAlert && this.state.mounted;\n\n      if (!this.props.userinfo.email && nextProps.userinfo.email) {\n        OcpToken.updateOcpTokenToEmail(nextProps.userinfo.email);\n      }\n\n      return true;\n    }\n  }, {\n    key: \"componentDidUpdate\",\n    value: function componentDidUpdate(prevProps) {}\n  }, {\n    key: \"componentWillUnmount\",\n    value: function componentWillUnmount() {\n      window.removeEventListener(\"focus\", this.handleWindowFocus);\n      window.removeEventListener(\"blur\", this.handleWindowBlur);\n      window.removeEventListener(\"message\", this.onMessage);\n    }\n  }, {\n    key: \"parseJwt\",\n    value: function parseJwt(token) {\n      var base64Url = token.split(\".\")[1];\n      var base64 = base64Url.replace(/-/g, \"+\").replace(/_/g, \"/\");\n      return JSON.parse(window.atob(base64));\n    }\n  }, {\n    key: \"handleLoginTokenFromQuery\",\n    value: function handleLoginTokenFromQuery() {\n      var params = QueryString.parse(window.location.search);\n      var loginToken = params.loginToken;\n\n      if (loginToken) {\n        localStorage.setItem(\"wizToken\", loginToken);\n        var replaceUrl = window.location.href.split(\"?\")[0];\n        window.history.replaceState({}, undefined, replaceUrl);\n      }\n    }\n  }, {\n    key: \"render\",\n    value: function render() {\n      return React.createElement(React.Fragment, {\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 176\n        },\n        __self: this\n      }, this.state.mounted === true ? this.props.children : null, this.shouldLogin && React.createElement(\"iframe\", {\n        title: \"tokenIFrame\",\n        ref: this.liveIframe,\n        src: this.state.wizliveURL + \"/tokenIFrame\",\n        style: {\n          display: \"none\"\n        },\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 179\n        },\n        __self: this\n      }));\n    }\n  }]);\n\n  return UserInfoContainer;\n}(React.Component);\n\nexport default connect(function (state) {\n  return {\n    userinfo: state.userinfo\n  };\n}, {\n  updateUserInfo: action.updateUserInfo\n})(withRouter(UserInfoContainer));","map":{"version":3,"sources":["/Users/jimmy/Documents/Wizschool/wizlab_web2/src/Common/Component/UserInfo/index.js"],"names":["React","QueryString","withRouter","URL","connect","request","action","OcpToken","UserInfoContainer","props","componentDidMount","window","addEventListener","handleWindowFocus","handleWindowBlur","onMessage","handleLoginTokenFromQuery","shouldLogin","Object","keys","userinfo","length","handleLoginByToken","setState","mounted","e","origin","WIZLIVE","WIZLIVE_WWW","includes","console","log","data","type","liveIframe","current","contentWindow","postMessage","localStorage","setItem","wizliveURL","token","getItem","params","loginByToken","response","json","user","payment","updateUserInfo","match","path","split","step","addOcpUser","email","grade","updateOcpToken","windowFocused","isNeedUpdate","parseJwt","tokenEmail","location","reload","state","showAlert","liveToken","undefined","createRef","nextProps","nextState","updateOcpTokenToEmail","prevProps","removeEventListener","base64Url","base64","replace","JSON","parse","atob","search","loginToken","replaceUrl","href","history","replaceState","children","display","Component"],"mappings":"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","sourcesContent":["import React from \"react\";\nimport QueryString from \"query-string\";\nimport { withRouter } from \"react-router-dom\";\nimport { URL } from \"../../Util/Constant.js\";\nimport { connect } from \"react-redux\";\nimport * as request from \"../../../Common/Util/HTTPRequest\";\nimport * as action from \"../../Store/Reducer/UserInfo\";\nimport * as OcpToken from \"../../Util/OcpToken\";\n// import { showBingoPopup } from \"../../../Common/Component/PopUp/BingoPopup\";\n\nclass UserInfoContainer extends React.Component {\n  constructor(props) {\n    super(props);\n    // console.log(\"UserInfoContainer constructor\", this.props);\n    this.state = { mounted: false, wizliveURL: URL.WIZLIVE };\n    this.showAlert = false;\n    this.shouldLogin =\n      this.props.match.path === \"/wizlive/:pId\" ||\n      this.props.match.path === \"/wizlive_1v4/:pId\" ||\n      this.props.match.path === \"/builder_edit/:pId\" ||\n      this.props.match.path === \"/builder_readonly/:pId\";\n    this.liveToken = undefined;\n    this.liveIframe = React.createRef();\n    this.windowFocused = true;\n  }\n\n  shouldComponentUpdate(nextProps, nextState) {\n    this.showAlert = this.showAlert && this.state.mounted;\n    if (!this.props.userinfo.email && nextProps.userinfo.email) {\n      OcpToken.updateOcpTokenToEmail(nextProps.userinfo.email);\n    }\n    return true;\n  }\n\n  componentDidMount = () => {\n    window.addEventListener(\"focus\", this.handleWindowFocus);\n    window.addEventListener(\"blur\", this.handleWindowBlur);\n    window.addEventListener(\"message\", this.onMessage, false);\n    this.handleLoginTokenFromQuery();\n\n    if (!this.shouldLogin) {\n      if (Object.keys(this.props.userinfo).length === 0) {\n        this.handleLoginByToken();\n      } else {\n        this.setState({ mounted: true });\n      }\n    }\n  };\n\n  componentDidUpdate(prevProps) {\n  }\n\n  componentWillUnmount() {\n    window.removeEventListener(\"focus\", this.handleWindowFocus);\n    window.removeEventListener(\"blur\", this.handleWindowBlur);\n    window.removeEventListener(\"message\", this.onMessage);\n  }\n\n  onMessage = e => {\n    // console.log(\"UserInfoContainer onMessage\", e);\n    if (e.origin === URL.WIZLIVE || e.origin === URL.WIZLIVE_WWW || e.origin.includes('redbrick')) {\n      console.log(3333, e.origin);\n      if (e.data.type === \"ready\") {\n        if (this.liveIframe.current) {\n          this.liveIframe.current.contentWindow.postMessage(\n            { type: \"requestToken\" },\n            \"*\"\n          );\n        }\n      } else if (e.data.type === \"token\") {\n        if (e.data.data) {\n          localStorage.setItem(\"wizToken\", e.data.data);\n          console.log(4444, e.data.data);\n          this.handleLoginByToken();\n        } else {\n          this.setState({ wizliveURL: URL.WIZLIVE_WWW });\n        }\n      } else {\n        // console.log(\"UserInfoContainer unknown data\", e.data);\n      }\n    }\n  };\n\n  handleLoginByToken = async e => {\n    const token = localStorage.getItem(\"wizToken\");\n    // console.log(\"login by token\", token);\n    if (token) {\n      const params = { token };\n      try {\n        console.log(5555, 'login by token');\n        const response = await request.loginByToken(params);\n        const json = await response.json();\n        if (json.user) {\n          let user = json.user;\n          user.payment = json.payment;\n          localStorage.setItem(\"wizToken\", json.token);\n          this.props.updateUserInfo(user);\n          this.setState({ mounted: true });\n        } else {\n          // console.log(\"user not found\");\n          // localStorage.removeItem(\"wizToken\");\n          this.props.updateUserInfo();\n          this.setState({ mounted: true });\n        }\n      } catch (err) {\n        // console.log(\"request failed\");\n        // localStorage.removeItem(\"wizToken\");\n        this.props.updateUserInfo();\n        this.setState({ mounted: true });\n      }\n    } else {\n      // console.log(\"token not found\");\n      // localStorage.removeItem(\"wizToken\");\n      this.props.updateUserInfo();\n      this.setState({ mounted: true });\n    }\n\n    //for ocp\n    if (\n      this.props.match.path.split(\"/\")[1] === \"ocp2\" &&\n      this.props.match.params.step === \"1\"\n    ) {\n      OcpToken.addOcpUser(\n        this.props.userinfo.email,\n        this.props.match.params.grade,\n        this.props.match.params.type\n          ? this.props.match.params.type\n          : this.props.match.path.split(\"/\")[2]\n      );\n    }\n    OcpToken.updateOcpToken();\n  };\n\n  handleWindowBlur = e => {\n    this.windowFocused = false;\n  };\n\n  handleWindowFocus = e => {\n    const isNeedUpdate = this.windowFocused === false;\n    this.windowFocused = true;\n    const token = localStorage.getItem(\"wizToken\");\n    if (token) {\n      const json = this.parseJwt(token);\n      const tokenEmail = json.email;\n      if (tokenEmail !== this.props.userinfo.email) {\n        window.location.reload();\n      } else {\n        if (isNeedUpdate) {\n          // this.checkUnreadBingoEvents();\n        }\n      }\n    }\n    if (!token && Object.keys(this.props.userinfo).length > 0) {\n      this.props.updateUserInfo();\n    }\n  };\n\n  parseJwt(token) {\n    var base64Url = token.split(\".\")[1];\n    var base64 = base64Url.replace(/-/g, \"+\").replace(/_/g, \"/\");\n    return JSON.parse(window.atob(base64));\n  }\n\n  handleLoginTokenFromQuery() {\n    const params = QueryString.parse(window.location.search);\n    const { loginToken } = params;\n    if (loginToken) {\n      localStorage.setItem(\"wizToken\", loginToken);\n      const replaceUrl = window.location.href.split(\"?\")[0];\n      window.history.replaceState({}, undefined, replaceUrl);\n    }\n  }\n\n  render() {\n    return (\n      <React.Fragment>\n        {this.state.mounted === true ? this.props.children : null}\n        {this.shouldLogin && (\n          <iframe\n            title=\"tokenIFrame\"\n            ref={this.liveIframe}\n            src={this.state.wizliveURL + \"/tokenIFrame\"}\n            style={{ display: \"none\" }}\n          />\n        )}\n      </React.Fragment>\n    );\n  }\n}\n\nexport default connect(\n  state => ({\n    userinfo: state.userinfo\n  }),\n  {\n    updateUserInfo: action.updateUserInfo\n  }\n)(withRouter(UserInfoContainer));\n"]},"metadata":{},"sourceType":"module"}