{"ast":null,"code":"import _regeneratorRuntime from \"/Users/jimmy/Documents/Wizschool/astroboy/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"/Users/jimmy/Documents/Wizschool/astroboy/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\nimport { ChatbotMsgType } from \"../../../Common/Util/Constant\";\nimport apiLibrary from \"./apiLibrary\";\nimport * as request from \"../../../Common/Util/HTTPRequest\";\n\nvar HmacSHA256 = require('crypto-js/hmac-sha256');\n\nvar EncBase64 = require('crypto-js/enc-base64');\n\nvar BASE_URL = \"https://5f0149f1b0d548388829c6002606fff2.apigw.ntruss.com/custom/v1/4600/92445c38557137a6e80a89c0804985beab9874539d5131ca4533726421ef81b9\";\nvar SECRET_KEY = \"Qm9HdklYRnhKWUJ0ZkJDRWpyUlhzY3RWV0hEVmhzckI=\";\nexport var SCENARIO_NAMES = {\n  API: \"programming\",\n  CLASS: \"class\"\n};\nvar WIZBOT = \"WIZBOT\";\n\nvar fetchRequest = function fetchRequest(url, method, param, signatureHeader) {\n  var headers = {\n    \"Content-Type\": \"application/json;UTF-8\",\n    \"X-NCP-CHATBOT_SIGNATURE\": signatureHeader\n  };\n\n  if (param) {\n    return fetch(url, {\n      method: method,\n      headers: headers,\n      body: JSON.stringify(param)\n    });\n  } else {\n    return fetch(url, {\n      method: method,\n      headers: headers\n    });\n  }\n};\n\nexport var sendMsg = function sendMsg(payload, onSuccess, onError) {\n  var body = {\n    \"version\": \"v2\",\n    \"userId\": payload.userId,\n    \"timestamp\": new Date().getTime(),\n    \"bubbles\": [{\n      \"type\": \"text\",\n      \"data\": {\n        \"description\": payload.description\n      }\n    }],\n    \"event\": \"send\"\n  };\n  var signatureHeader = HmacSHA256(JSON.stringify(body), SECRET_KEY).toString(EncBase64);\n  fetchRequest(\"\".concat(BASE_URL), \"POST\", body, signatureHeader).then(function (res) {\n    return res.json();\n  }).then( /*#__PURE__*/function () {\n    var _ref = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(data) {\n      var canNotHelp, messages, failedMessage, entityValues, res, projects, msg;\n      return _regeneratorRuntime.wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              // console.log(11111, \"CLOVA RESPONSE :\", data)\n              canNotHelp = false;\n              messages = [];\n              data.bubbles.forEach(function (bubble) {\n                var msg = {\n                  text: bubble.data.description,\n                  sender: WIZBOT\n                };\n                messages.push(msg);\n                canNotHelp = !!bubble.information.find(function (i) {\n                  return i.key === \"defaultMsgType\" && i.value === \"canNotHelpMsg\";\n                });\n              }); //add additional info\n\n              if (canNotHelp) {\n                _context.next = 31;\n                break;\n              }\n\n              _context.t0 = data.scenario.name;\n              _context.next = _context.t0 === SCENARIO_NAMES.API ? 7 : _context.t0 === SCENARIO_NAMES.CLASS ? 9 : 30;\n              break;\n\n            case 7:\n              data.entities.forEach(function (entity) {\n                if (entity.name === \"API\") {\n                  var api = apiLibrary.getAPIbyId(entity.word);\n\n                  if (api) {\n                    messages.push({\n                      text: api.chatbotDescription,\n                      sender: WIZBOT,\n                      type: ChatbotMsgType.BOT_API_SCRIPT,\n                      script: \"//\" + entity.word + \"예제 스크립트:\\n\" + api.snippet\n                    });\n                    messages.push({\n                      type: ChatbotMsgType.BOT_BUTTON,\n                      keyword: api.id,\n                      questionType: \"class\"\n                    });\n                  }\n                }\n              });\n              return _context.abrupt(\"break\", 31);\n\n            case 9:\n              failedMessage = {\n                text: \"앗! 아직은 준비 된 수업이 없네..\",\n                sender: WIZBOT\n              };\n              entityValues = data.entities.map(function (entity) {\n                return entity.word;\n              });\n\n              if (!(entityValues.length > 0)) {\n                _context.next = 28;\n                break;\n              }\n\n              _context.prev = 12;\n              _context.next = 15;\n              return request.getDreamProjectsByTag(entityValues[0]);\n\n            case 15:\n              res = _context.sent;\n              _context.next = 18;\n              return res.json();\n\n            case 18:\n              projects = _context.sent;\n\n              if (projects.length > 0) {\n                msg = {\n                  text: entityValues[0] + \"을(를) 배우기 위해서 내가 준비한 수업이야~\",\n                  sender: WIZBOT\n                };\n                messages.push(msg);\n                messages.push({\n                  type: ChatbotMsgType.BOT_CLASS,\n                  lectures: projects,\n                  sender: WIZBOT\n                });\n              } else {\n                messages = [failedMessage];\n              }\n\n              _context.next = 26;\n              break;\n\n            case 22:\n              _context.prev = 22;\n              _context.t1 = _context[\"catch\"](12);\n              messages = [failedMessage];\n              console.error(_context.t1);\n\n            case 26:\n              _context.next = 29;\n              break;\n\n            case 28:\n              messages = [failedMessage];\n\n            case 29:\n              return _context.abrupt(\"break\", 31);\n\n            case 30:\n              return _context.abrupt(\"break\", 31);\n\n            case 31:\n              onSuccess(messages);\n\n            case 32:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee, null, [[12, 22]]);\n    }));\n\n    return function (_x) {\n      return _ref.apply(this, arguments);\n    };\n  }()).catch(function (e) {\n    return onError(e);\n  });\n};","map":{"version":3,"sources":["/Users/jimmy/Documents/Wizschool/astroboy/src/Page/Builder/utils/ChatbotUtil.js"],"names":["ChatbotMsgType","apiLibrary","request","HmacSHA256","require","EncBase64","BASE_URL","SECRET_KEY","SCENARIO_NAMES","API","CLASS","WIZBOT","fetchRequest","url","method","param","signatureHeader","headers","fetch","body","JSON","stringify","sendMsg","payload","onSuccess","onError","userId","Date","getTime","description","toString","then","res","json","data","canNotHelp","messages","bubbles","forEach","bubble","msg","text","sender","push","information","find","i","key","value","scenario","name","entities","entity","api","getAPIbyId","word","chatbotDescription","type","BOT_API_SCRIPT","script","snippet","BOT_BUTTON","keyword","id","questionType","failedMessage","entityValues","map","length","getDreamProjectsByTag","projects","BOT_CLASS","lectures","console","error","catch","e"],"mappings":"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","sourcesContent":["import { ChatbotMsgType } from \"../../../Common/Util/Constant\";\nimport apiLibrary from \"./apiLibrary\";\nimport * as request from \"../../../Common/Util/HTTPRequest\";\nconst HmacSHA256 = require('crypto-js/hmac-sha256');\nconst EncBase64 = require('crypto-js/enc-base64');\nconst BASE_URL = \"https://5f0149f1b0d548388829c6002606fff2.apigw.ntruss.com/custom/v1/4600/92445c38557137a6e80a89c0804985beab9874539d5131ca4533726421ef81b9\";\nconst SECRET_KEY = \"Qm9HdklYRnhKWUJ0ZkJDRWpyUlhzY3RWV0hEVmhzckI=\";\n\n\n\nexport const SCENARIO_NAMES = {\n  API: \"programming\",\n  CLASS: \"class\"\n}\n\nconst WIZBOT = \"WIZBOT\"\n\nconst fetchRequest = (url, method, param, signatureHeader) => {\n  let headers = {\n    \"Content-Type\": \"application/json;UTF-8\",\n    \"X-NCP-CHATBOT_SIGNATURE\": signatureHeader\n  };\n\n  if (param) {\n    return fetch(url, {\n      method: method,\n      headers: headers,\n      body: JSON.stringify(param)\n    });\n  } else {\n    return fetch(url, {\n      method: method,\n      headers: headers\n    });\n  }\n};\n\nexport const sendMsg = (payload, onSuccess, onError) => {\n  const body = {\n    \"version\": \"v2\",\n    \"userId\": payload.userId,\n    \"timestamp\": new Date().getTime(),\n    \"bubbles\": [{\n      \"type\": \"text\",\n      \"data\": { \"description\": payload.description }\n    }\n    ],\n    \"event\": \"send\"\n  }\n  const signatureHeader = HmacSHA256(JSON.stringify(body), SECRET_KEY).toString(EncBase64);\n  fetchRequest(`${BASE_URL}`, \"POST\", body, signatureHeader)\n    .then(res => res.json())\n    .then(async data => {\n      // console.log(11111, \"CLOVA RESPONSE :\", data)\n      let canNotHelp = false;\n      let messages = [];\n      data.bubbles.forEach(bubble => {\n        const msg = {\n          text: bubble.data.description,\n          sender: WIZBOT\n        }\n        messages.push(msg);\n        canNotHelp = !!bubble.information.find(i => i.key === \"defaultMsgType\" && i.value === \"canNotHelpMsg\");\n      })\n\n      //add additional info\n      if (!canNotHelp) {\n        switch (data.scenario.name) {\n          case SCENARIO_NAMES.API:\n            data.entities.forEach(entity => {\n              if (entity.name === \"API\") {\n                const api = apiLibrary.getAPIbyId(entity.word);\n                if (api) {\n                  messages.push({\n                    text: api.chatbotDescription,\n                    sender: WIZBOT,\n                    type: ChatbotMsgType.BOT_API_SCRIPT,\n                    script: \"//\" + entity.word + \"예제 스크립트:\\n\"+api.snippet\n                  });\n                  messages.push({\n                    type: ChatbotMsgType.BOT_BUTTON,\n                    keyword: api.id,\n                    questionType: \"class\"\n                  })\n                }\n              }\n            })\n            break;\n          case SCENARIO_NAMES.CLASS:\n            const failedMessage = {\n              text: \"앗! 아직은 준비 된 수업이 없네..\",\n              sender: WIZBOT,\n            };\n            const entityValues = data.entities.map(entity => entity.word);\n            if(entityValues.length > 0) {\n              try{\n                const res = await request.getDreamProjectsByTag(entityValues[0])\n                const projects = await res.json();\n                if(projects.length>0){\n                  const msg = {\n                    text: entityValues[0] + \"을(를) 배우기 위해서 내가 준비한 수업이야~\",\n                    sender: WIZBOT\n                  }\n                  messages.push(msg);\n                  messages.push({\n                    type: ChatbotMsgType.BOT_CLASS,\n                    lectures: projects,\n                    sender: WIZBOT\n                  })\n                } else {\n                  messages = [failedMessage];\n                }\n              } catch(e) {\n                messages = [failedMessage];\n                console.error(e);\n              }\n            } else {\n              messages = [failedMessage];\n            }\n            break;\n          default:\n            break;\n        }\n      }\n      onSuccess(messages);\n    })\n    .catch(e => onError(e));\n};\n"]},"metadata":{},"sourceType":"module"}