{"ast":null,"code":"import _regeneratorRuntime from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\nimport _classCallCheck from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";\nimport _inherits from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/inherits\";\nimport _possibleConstructorReturn from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"/Users/jimmy/Documents/Wizschool/wizlab_web2/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/getPrototypeOf\";\nvar _jsxFileName = \"/Users/jimmy/Documents/Wizschool/wizlab_web2/src/Common/Component/InstantMobileRun/index.js\";\n\nfunction _createSuper(Derived) { var hasNativeReflectConstruct = _isNativeReflectConstruct(); return function _createSuperInternal() { var Super = _getPrototypeOf(Derived), result; if (hasNativeReflectConstruct) { var NewTarget = _getPrototypeOf(this).constructor; result = Reflect.construct(Super, arguments, NewTarget); } else { result = Super.apply(this, arguments); } return _possibleConstructorReturn(this, result); }; }\n\nfunction _isNativeReflectConstruct() { if (typeof Reflect === \"undefined\" || !Reflect.construct) return false; if (Reflect.construct.sham) return false; if (typeof Proxy === \"function\") return true; try { Boolean.prototype.valueOf.call(Reflect.construct(Boolean, [], function () {})); return true; } catch (e) { return false; } }\n\nimport React, { Component } from \"react\";\nimport \"./index.scss\";\nimport { connect } from \"react-redux\";\nimport { injectIntl } from \"react-intl\";\nimport * as request from \"../../Util/HTTPRequest\";\nimport { URL } from \"../../Util/Constant\";\nimport generateGamePage from \"../../../Page/Builder/utils/gamePageGenerator\";\nimport * as socketActions from \"../../../Page/Builder/Store/Reducer/socket\";\nimport closeImg from \"../../../Image/builder/x-copy-3.svg\";\nimport closeImg_darkmode from \"../../../Image/builder/x-copy-3_darkmode.svg\";\nimport { getColorTheme } from \"../../../Page/Builder/utils/colorThemeUtil\";\n\nvar InstantMobileRun = /*#__PURE__*/function (_Component) {\n  _inherits(InstantMobileRun, _Component);\n\n  var _super = _createSuper(InstantMobileRun);\n\n  function InstantMobileRun(props) {\n    var _this;\n\n    _classCallCheck(this, InstantMobileRun);\n\n    _this = _super.call(this, props);\n\n    _this.componentDidMount = function () {\n      _this.sendRequestToMobile();\n      /*for css */\n\n\n      var popup = document.querySelector(\".InstantMobileRun\").closest(\".popup_contents\");\n      popup.style.borderRadius = \"20px\";\n      var dismissBtn = popup.querySelector(\"#popup_dismissbtn\");\n      dismissBtn.style.display = \"none\";\n    };\n\n    _this.generateLink = /*#__PURE__*/_asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee() {\n      var _this$props$project, pId, name, state, gameMeta, doc, res, json;\n\n      return _regeneratorRuntime.wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              _this$props$project = _this.props.project, pId = _this$props$project.pId, name = _this$props$project.name;\n              /** made gamePage html  */\n\n              state = {\n                editorMode: _this.props.scene.editorMode,\n                scene: {\n                  scenes: _this.props.scene.scenes,\n                  sceneIds: _this.props.scene.sceneIds,\n                  soundIds: _this.props.scene.soundIds,\n                  soundNames: _this.props.scene.soundNames\n                },\n                preview: {\n                  screenMode: _this.props.preview.screenMode\n                }\n              };\n              gameMeta = {\n                pId: pId,\n                gameTitle: name,\n                liveTest: true\n              };\n              _context.prev = 3;\n              _context.next = 6;\n              return generateGamePage(state, gameMeta);\n\n            case 6:\n              doc = _context.sent;\n              _context.next = 9;\n              return request.uploadPublished({\n                doc: doc\n              });\n\n            case 9:\n              res = _context.sent;\n              _context.next = 12;\n              return res.json();\n\n            case 12:\n              json = _context.sent;\n              _context.next = 15;\n              return request.updateDevelopingProject({\n                pId: pId,\n                url: json.url\n              });\n\n            case 15:\n              return _context.abrupt(\"return\", json.url);\n\n            case 18:\n              _context.prev = 18;\n              _context.t0 = _context[\"catch\"](3);\n              console.error(_context.t0);\n\n            case 21:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee, null, [[3, 18]]);\n    }));\n\n    _this.handleRetryBtn = function () {\n      _this.setState({\n        isWaiting: true\n      }, function () {\n        _this.sendRequestToMobile();\n      });\n    };\n\n    _this.sendRequestToMobile = /*#__PURE__*/_asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2() {\n      var url, pId, playerUrl, response, result;\n      return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n        while (1) {\n          switch (_context2.prev = _context2.next) {\n            case 0:\n              _context2.prev = 0;\n              _context2.next = 3;\n              return _this.generateLink();\n\n            case 3:\n              url = _context2.sent;\n\n              _this.props.setInstantRunURL(url); // firebase message push\n\n\n              pId = _this.props.project.pId;\n              playerUrl = URL.LIVE_TEST + pId; // push to mobile by server\n\n              _context2.next = 9;\n              return request.pushInstantRun({\n                email: _this.props.email,\n                url: playerUrl\n              });\n\n            case 9:\n              response = _context2.sent;\n              _context2.next = 12;\n              return response.json();\n\n            case 12:\n              result = _context2.sent;\n\n              if (result && result.status === \"failed\") {\n                // console.log(\"failed before timeout\");\n                _this.setState({\n                  isWaiting: false\n                });\n              } else {\n                // warning:\n                // there is a case that component unmounted before this code run,\n                // because socketContainer emit url at the same time.\n                _this.pushTimer = window.setTimeout(function () {\n                  console.log(\"failed after timeout\");\n\n                  _this.setState({\n                    isWaiting: false\n                  });\n                }, _this.pushTimeLimit);\n              }\n\n              _context2.next = 19;\n              break;\n\n            case 16:\n              _context2.prev = 16;\n              _context2.t0 = _context2[\"catch\"](0);\n              console.error(_context2.t0);\n\n            case 19:\n            case \"end\":\n              return _context2.stop();\n          }\n        }\n      }, _callee2, null, [[0, 16]]);\n    }));\n    _this.pushTimer = null;\n    _this.pushTimeLimit = 5000;\n    _this.state = {\n      isWaiting: true\n    };\n    return _this;\n  }\n\n  _createClass(InstantMobileRun, [{\n    key: \"componentWillUnmount\",\n    value: function componentWillUnmount() {\n      window.clearTimeout(this.pushTimer);\n    }\n  }, {\n    key: \"render\",\n    value: function render() {\n      var isWaiting = this.state.isWaiting;\n      var intl = this.props.intl;\n      var colorTheme = getColorTheme();\n      return /*#__PURE__*/React.createElement(\"div\", {\n        className: \"InstantMobileRun\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 123,\n          columnNumber: 7\n        }\n      }, /*#__PURE__*/React.createElement(\"div\", {\n        className: \"InstantMobileRun__header\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 124,\n          columnNumber: 9\n        }\n      }, /*#__PURE__*/React.createElement(\"img\", {\n        className: \"Popup__closeBtn\",\n        onClick: this.props.dismiss,\n        src: colorTheme === \"darkMode\" ? closeImg_darkmode : closeImg,\n        alt: \"close\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 125,\n          columnNumber: 11\n        }\n      })), isWaiting ? /*#__PURE__*/React.createElement(\"div\", {\n        className: \"InstantMobileRun__content--waiting\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 133,\n          columnNumber: 11\n        }\n      }, /*#__PURE__*/React.createElement(\"div\", {\n        className: \"waiting__phone\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 134,\n          columnNumber: 13\n        }\n      }, /*#__PURE__*/React.createElement(\"div\", {\n        className: \"waiting__phone__inner\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 135,\n          columnNumber: 15\n        }\n      }, /*#__PURE__*/React.createElement(\"p\", {\n        className: \"waiting__icon\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 136,\n          columnNumber: 17\n        }\n      }))), /*#__PURE__*/React.createElement(\"p\", {\n        className: \"title title--waiting\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 139,\n          columnNumber: 13\n        }\n      }, intl.formatMessage({\n        id: \"ID_POPUP_MOBILE_WAITING_TITLE\"\n      })), /*#__PURE__*/React.createElement(\"p\", {\n        className: \"text text--waiting\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 142,\n          columnNumber: 13\n        }\n      }, intl.formatMessage({\n        id: \"ID_POPUP_MOBILE_WAITING_DESC\"\n      }))) : /*#__PURE__*/React.createElement(\"div\", {\n        className: \"InstantMobileRun__content--retry\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 147,\n          columnNumber: 11\n        }\n      }, /*#__PURE__*/React.createElement(\"p\", {\n        className: \"title title--retry\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 148,\n          columnNumber: 13\n        }\n      }, intl.formatMessage({\n        id: \"ID_POPUP_MOBILE_FAIL_TITLE\"\n      })), /*#__PURE__*/React.createElement(\"ol\", {\n        className: \"Popup__caseList\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 151,\n          columnNumber: 13\n        }\n      }, /*#__PURE__*/React.createElement(\"li\", {\n        className: \"text\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 152,\n          columnNumber: 15\n        }\n      }, intl.formatMessage({\n        id: \"ID_POPUP_MOBILE_FAIL_DESC_01\"\n      })), /*#__PURE__*/React.createElement(\"li\", {\n        className: \"text\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 155,\n          columnNumber: 15\n        }\n      }, intl.formatMessage({\n        id: \"ID_POPUP_MOBILE_FAIL_DESC_02\"\n      })), /*#__PURE__*/React.createElement(\"li\", {\n        className: \"text\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 158,\n          columnNumber: 15\n        }\n      }, intl.formatMessage({\n        id: \"ID_POPUP_MOBILE_FAIL_DESC_03\"\n      }))), /*#__PURE__*/React.createElement(\"div\", {\n        className: \"Popup__storeRow\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 162,\n          columnNumber: 13\n        }\n      }, /*#__PURE__*/React.createElement(\"a\", {\n        href: URL.APP_STORE,\n        target: \"_blank\",\n        rel: \"noopener noreferrer\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 163,\n          columnNumber: 15\n        }\n      }, /*#__PURE__*/React.createElement(\"p\", {\n        className: \"Popup__store Popup__store--apple\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 164,\n          columnNumber: 17\n        }\n      })), /*#__PURE__*/React.createElement(\"a\", {\n        href: URL.PLAY_STORE,\n        target: \"_blank\",\n        rel: \"noopener noreferrer\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 166,\n          columnNumber: 15\n        }\n      }, /*#__PURE__*/React.createElement(\"p\", {\n        className: \"Popup__store Popup__store--google\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 171,\n          columnNumber: 17\n        }\n      }))), /*#__PURE__*/React.createElement(\"div\", {\n        className: \"retry__submitBtn\",\n        onClick: this.handleRetryBtn,\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 175,\n          columnNumber: 13\n        }\n      }, /*#__PURE__*/React.createElement(\"p\", {\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 176,\n          columnNumber: 15\n        }\n      }, intl.formatMessage({\n        id: \"ID_POPUP_MOBILE_FAIL_BTN\"\n      })))));\n    }\n  }]);\n\n  return InstantMobileRun;\n}(Component);\n\nexport default connect(function (state) {\n  return {\n    project: state.project,\n    scene: state.scene,\n    preview: state.preview,\n    email: state.userinfo.email\n  };\n}, {\n  setInstantRunURL: socketActions.setInstantRunURL\n})(injectIntl(InstantMobileRun));","map":{"version":3,"sources":["/Users/jimmy/Documents/Wizschool/wizlab_web2/src/Common/Component/InstantMobileRun/index.js"],"names":["React","Component","connect","injectIntl","request","URL","generateGamePage","socketActions","getColorTheme","InstantMobileRun","props","componentDidMount","sendRequestToMobile","popup","document","querySelector","closest","style","borderRadius","dismissBtn","display","generateLink","project","pId","name","state","editorMode","scene","scenes","sceneIds","soundIds","soundNames","preview","screenMode","gameMeta","gameTitle","liveTest","doc","uploadPublished","res","json","updateDevelopingProject","url","console","error","handleRetryBtn","setState","isWaiting","setInstantRunURL","playerUrl","LIVE_TEST","pushInstantRun","email","response","result","status","pushTimer","window","setTimeout","log","pushTimeLimit","clearTimeout","intl","colorTheme","dismiss","closeImg_darkmode","closeImg","formatMessage","id","APP_STORE","PLAY_STORE","userinfo"],"mappings":"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","sourcesContent":["import React, { Component } from \"react\";\nimport \"./index.scss\";\nimport { connect } from \"react-redux\";\nimport { injectIntl } from \"react-intl\";\nimport * as request from \"../../Util/HTTPRequest\";\nimport { URL } from \"../../Util/Constant\";\nimport generateGamePage from \"../../../Page/Builder/utils/gamePageGenerator\";\nimport * as socketActions from \"../../../Page/Builder/Store/Reducer/socket\";\nimport closeImg from \"../../../Image/builder/x-copy-3.svg\";\nimport closeImg_darkmode from \"../../../Image/builder/x-copy-3_darkmode.svg\";\nimport { getColorTheme } from \"../../../Page/Builder/utils/colorThemeUtil\";\n\nclass InstantMobileRun extends Component {\n  constructor(props) {\n    super(props);\n    this.pushTimer = null;\n    this.pushTimeLimit = 5000;\n    this.state = {\n      isWaiting: true\n    };\n  }\n\n  componentDidMount = () => {\n    this.sendRequestToMobile();\n    /*for css */\n    const popup = document\n      .querySelector(\".InstantMobileRun\")\n      .closest(\".popup_contents\");\n    popup.style.borderRadius = \"20px\";\n    const dismissBtn = popup.querySelector(\"#popup_dismissbtn\");\n    dismissBtn.style.display = \"none\";\n  };\n\n  componentWillUnmount() {\n    window.clearTimeout(this.pushTimer);\n  }\n  generateLink = async () => {\n    const { pId, name } = this.props.project;\n    /** made gamePage html  */\n    const state = {\n      editorMode: this.props.scene.editorMode,\n      scene: {\n        scenes: this.props.scene.scenes,\n        sceneIds: this.props.scene.sceneIds,\n        soundIds: this.props.scene.soundIds,\n        soundNames: this.props.scene.soundNames\n      },\n      preview: {\n        screenMode: this.props.preview.screenMode\n      }\n    };\n\n    const gameMeta = {\n      pId,\n      gameTitle: name,\n      liveTest: true\n    };\n    try {\n      const doc = await generateGamePage(state, gameMeta);\n      /** upload gamePage html  */\n      let res = await request.uploadPublished({ doc });\n      let json = await res.json();\n      await request.updateDevelopingProject({ pId, url: json.url });\n\n      return json.url;\n    } catch (e) {\n      console.error(e);\n    }\n  };\n\n  handleRetryBtn = () => {\n    this.setState(\n      {\n        isWaiting: true\n      },\n      () => {\n        this.sendRequestToMobile();\n      }\n    );\n  };\n\n  sendRequestToMobile = async () => {\n    try {\n      // socket\n      const url = await this.generateLink();\n      this.props.setInstantRunURL(url);\n      // firebase message push\n      const { pId } = this.props.project;\n      let playerUrl = URL.LIVE_TEST + pId;\n\n      // push to mobile by server\n      let response = await request.pushInstantRun({\n        email: this.props.email,\n        url: playerUrl\n      });\n      let result = await response.json();\n      if (result && result.status === \"failed\") {\n        // console.log(\"failed before timeout\");\n        this.setState({\n          isWaiting: false\n        });\n      } else {\n        // warning:\n        // there is a case that component unmounted before this code run,\n        // because socketContainer emit url at the same time.\n        this.pushTimer = window.setTimeout(() => {\n          console.log(\"failed after timeout\");\n          this.setState({\n            isWaiting: false\n          });\n        }, this.pushTimeLimit);\n      }\n    } catch (err) {\n      console.error(err);\n    }\n  };\n  render() {\n    const { isWaiting } = this.state;\n    const { intl } = this.props;\n    const colorTheme = getColorTheme();\n\n    return (\n      <div className=\"InstantMobileRun\">\n        <div className=\"InstantMobileRun__header\">\n          <img\n            className=\"Popup__closeBtn\"\n            onClick={this.props.dismiss}\n            src={colorTheme === \"darkMode\" ? closeImg_darkmode : closeImg}\n            alt=\"close\"\n          />\n        </div>\n        {isWaiting ? (\n          <div className=\"InstantMobileRun__content--waiting\">\n            <div className=\"waiting__phone\">\n              <div className=\"waiting__phone__inner\">\n                <p className=\"waiting__icon\" />\n              </div>\n            </div>\n            <p className=\"title title--waiting\">\n              {intl.formatMessage({ id: \"ID_POPUP_MOBILE_WAITING_TITLE\" })}\n            </p>\n            <p className=\"text text--waiting\">\n              {intl.formatMessage({ id: \"ID_POPUP_MOBILE_WAITING_DESC\" })}\n            </p>\n          </div>\n        ) : (\n          <div className=\"InstantMobileRun__content--retry\">\n            <p className=\"title title--retry\">\n              {intl.formatMessage({ id: \"ID_POPUP_MOBILE_FAIL_TITLE\" })}\n            </p>\n            <ol className=\"Popup__caseList\">\n              <li className=\"text\">\n                {intl.formatMessage({ id: \"ID_POPUP_MOBILE_FAIL_DESC_01\" })}\n              </li>\n              <li className=\"text\">\n                {intl.formatMessage({ id: \"ID_POPUP_MOBILE_FAIL_DESC_02\" })}\n              </li>\n              <li className=\"text\">\n                {intl.formatMessage({ id: \"ID_POPUP_MOBILE_FAIL_DESC_03\" })}\n              </li>\n            </ol>\n            <div className=\"Popup__storeRow\">\n              <a href={URL.APP_STORE} target=\"_blank\" rel=\"noopener noreferrer\">\n                <p className=\"Popup__store Popup__store--apple\" />\n              </a>\n              <a\n                href={URL.PLAY_STORE}\n                target=\"_blank\"\n                rel=\"noopener noreferrer\"\n              >\n                <p className=\"Popup__store Popup__store--google\" />\n              </a>\n            </div>\n\n            <div className=\"retry__submitBtn\" onClick={this.handleRetryBtn}>\n              <p>{intl.formatMessage({ id: \"ID_POPUP_MOBILE_FAIL_BTN\" })}</p>\n            </div>\n          </div>\n        )}\n      </div>\n    );\n  }\n}\nexport default connect(\n  state => ({\n    project: state.project,\n    scene: state.scene,\n    preview: state.preview,\n    email: state.userinfo.email\n  }),\n  {\n    setInstantRunURL: socketActions.setInstantRunURL\n  }\n)(injectIntl(InstantMobileRun));\n"]},"metadata":{},"sourceType":"module"}